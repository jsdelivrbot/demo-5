<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mybatisPro.myBatisDao.RainfallStatisticsMapper">
	<cache type="mybatisPro.mybatisRedis.MybatisRedisCache" />
	
	<!-- 小时 -->
	<insert id="statisticsByHour" statementType="CALLABLE" >
		{CALL rwdb.STATISTICAL_HOURS()}
	</insert>
	
	<!-- 天 -->
	<insert id="statisticsByDays" statementType="CALLABLE" >
		{CALL rwdb.STATISTICAL_DAYS()}
	</insert>
	
	<!-- 月 -->
	<insert id="statisticsByMonths" statementType="CALLABLE" >
		{CALL rwdb.STATISTICAL_MONTH()}
	</insert>
	
	<!-- 年统计 -->
	<select id="statisticsByYear"  resultType="map" useCache="false">
		SELECT
		   `ST_BS_STBPRP_B`.`sys_code`
		   , `ST_BS_STBPRP_B`.`station_name`
		    ,SUM(CASE YEAR(TIME) WHEN #{year} THEN time_rainfall ELSE 0 END) AS total
		   ,SUM(CASE MONTH(TIME) WHEN 1 THEN time_rainfall ELSE 0.0 END) AS Jan
		   ,SUM(CASE MONTH(TIME) WHEN 2 THEN time_rainfall ELSE 0.0 END) AS Feb
		   ,SUM(CASE MONTH(TIME) WHEN 3 THEN time_rainfall ELSE 0.0 END) AS Mar
		   ,SUM(CASE MONTH(TIME) WHEN 4 THEN time_rainfall ELSE 0.0 END) AS Apr
		   ,SUM(CASE MONTH(TIME) WHEN 5 THEN time_rainfall ELSE 0.0 END) AS May
		   ,SUM(CASE MONTH(TIME) WHEN 6 THEN time_rainfall ELSE 0.0 END) AS Jun
		   ,SUM(CASE MONTH(TIME) WHEN 7 THEN time_rainfall ELSE 0.0 END) AS Jul
		   ,SUM(CASE MONTH(TIME) WHEN 8 THEN time_rainfall ELSE 0.0 END) AS Aug
		   ,SUM(CASE MONTH(TIME) WHEN 9 THEN time_rainfall ELSE 0.0 END) AS Sep
		   ,SUM(CASE MONTH(TIME) WHEN 10 THEN time_rainfall ELSE 0.0 END) AS Octb
		   ,SUM(CASE MONTH(TIME) WHEN 11 THEN time_rainfall ELSE 0.0 END) AS Nov
		   ,SUM(CASE MONTH(TIME) WHEN 12 THEN time_rainfall ELSE 0.0 END) AS Dece
	    FROM
	    	`rwdb`.`ST_RP_PPTN1M_R`
		    INNER JOIN `rwdb`.`ST_BS_STBPRP_B` 
		        ON (`ST_RP_PPTN1M_R`.`sta_id` = `ST_BS_STBPRP_B`.`id`)
		   <!--  INNER JOIN `rwdb`.`ST_BS_STTYPE_B` 
		        ON (`ST_BS_STBPRP_B`.`station_type_id` = `ST_BS_STTYPE_B`.`sta_type_id`) -->
	    WHERE
	   		YEAR(TIME)=#{year} AND ST_BS_STBPRP_B.`station_type`=#{type}
	    GROUP BY `ST_BS_STBPRP_B`.`station_name`
	</select>
	
	<!-- 天统计 -->
	<select id="statisticsByDay"  resultType="map" useCache="false">
		SELECT
		   `ST_BS_STBPRP_B`.`sys_code`
		   , `ST_BS_STBPRP_B`.`station_name`
		   ,SUM(time_rainfall) AS total
		   <foreach collection="hour_list" index="index" item="item" >
		   		,SUM(CASE HOUR(TIME) WHEN #{item} THEN time_rainfall ELSE 0.0 END) AS #{item}
		   </foreach>
	    FROM
		    	`rwdb`.`ST_RP_PPTN1H_R`
		    INNER JOIN `rwdb`.`ST_BS_STBPRP_B` 
		        ON (`ST_RP_PPTN1H_R`.`sta_id` = `ST_BS_STBPRP_B`.`id`)
		   <!--  INNER JOIN `rwdb`.`ST_BS_STTYPE_B` 
		        ON (`ST_BS_STBPRP_B`.`station_type_id` = `ST_BS_STTYPE_B`.`sta_type_id`) -->
	    WHERE
	   		TIME BETWEEN #{start_time}  AND #{end_time} AND ST_BS_STBPRP_B.`station_type`=6
	    GROUP BY `ST_BS_STBPRP_B`.`station_name`
	</select>
	
	<!-- 月统计 -->
	<select id="statisticsByMonth"  resultType="map" useCache="false">
		SELECT
		   `ST_BS_STBPRP_B`.`sys_code`
		   ,`ST_BS_STBPRP_B`.`station_name`
		   ,SUM(time_rainfall) AS total
		   <foreach collection="month_list" index="index" item="item" >
		   		,SUM(CASE DAY(TIME) WHEN #{item} THEN time_rainfall ELSE 0.0 END) AS #{item}
		   </foreach>
	   FROM
	   	 	`rwdb`.`ST_RP_PPTN1D_R`
		   INNER JOIN `rwdb`.`ST_BS_STBPRP_B` 
		       ON (`ST_RP_PPTN1D_R`.`sta_id` = `ST_BS_STBPRP_B`.`id`)
		   <!-- INNER JOIN `rwdb`.`ST_BS_STTYPE_B` 
		       ON (`ST_BS_STBPRP_B`.`station_type_id` = `ST_BS_STTYPE_B`.`sta_type_id`) -->
	   WHERE
	    	DATE_FORMAT(TIME,'%Y-%m')=#{months} AND ST_BS_STBPRP_B.station_type=#{type}
	   GROUP BY ST_BS_STBPRP_B.`station_name`
	</select>
	
	
</mapper>