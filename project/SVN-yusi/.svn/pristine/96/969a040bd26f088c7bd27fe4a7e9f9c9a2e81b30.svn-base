var flag=0;  //0:日; 1:月; 2:年
var myArr;
//获取当前日期

function DateToday(flag) {
  var d = new Date();
  var year = d.getFullYear();
  var month = d.getMonth() + 1;
  if (month < 10) {
    month = '0' + month;

  }
  var day = d.getDate();
  if (day < 10) {
    day = '0' + day;
  }
  var hour = d.getHours();
  if (hour < 10) {
    hour = '0' + hour;
  }
  var min = d.getMinutes();
 if (min < 10) {
    min = '0' + min;
  }
  var str;
  if(flag=="years"){
	str = year;
	return str;
  }else if(flag=="months"){
	str = year + "-" + month ;
	return str;
  }else if(flag=="days"){
  	str = year + "-" + month + "-" + day;
  	return str;
  }

}

function datePrev(flag){

  if (flag === 0) {//日统计
      var year= $('#daysPicker').val().split("-")[0];
      var month= $('#daysPicker').val().split("-")[1];
      var day = $('#daysPicker').val().split("-")[2];
      day--;


      if(day<10){
          day='0'+day;
        if(day<1){
          month-=1;
          if(month<10){
            month='0'+month;
          }
          day=getLastDay(year,month);
        }
      }
      $('#daysPicker').val(year+'-'+month+'-'+day);
  }else if (flag === 1) {//月统计
      var year= $('#monthsPicker').val().split("-")[0];
      var month = $('#monthsPicker').val().split("-")[1];
      month--;
     if(month<1){
        month=12;
        year-=1;
     }

      if(month<10){
          month='0'+month;
      }
      $('#monthsPicker').val(year+'-'+month);
  }else{//年统计

      var year = $('#yearsPicker').val().split("-")[0];
      year--;
      $('#yearsPicker').val(year);
  }

}
function dateNext(flag){
  var d=new Date();
  if (flag === 0) {//日统计
      var year= $('#daysPicker').val().split("-")[0];
      var month=$('#daysPicker').val().split("-")[1];
      var day = $('#daysPicker').val().split("-")[2];
      day++;
      if(day<10){
        day='0'+day;
      }
      if(year==d.getFullYear()&&month==d.getMonth()+1&&day>d.getDate()){
        return ;
      }
      if(day>getLastDay(year,month)){
        month=Number(month)+1;
        day=1;
        if(day<10){
          day='0'+day;
        }
        if(month<10){
          month='0'+month;
        }
      }
      $('#daysPicker').val(year+'-'+month+'-'+day);
  }else if (flag === 1) {//月统计
      var year= $('#monthsPicker').val().split("-")[0];
      var month = $('#monthsPicker').val().split("-")[1];
      month++;
      if(month<10){
        month='0'+month;
      }

      if(month>12){
        year++;
        month-=12;
        if(month<10){
          month='0'+month;
        }
      }
      if(year==d.getFullYear()&&month>d.getMonth()+1){
          return ;
      }
      $('#monthsPicker').val(year+'-'+month);

  }else{//年统计

      var year = $('#yearsPicker').val().split("-")[0];

      if(year==d.getFullYear()){
        return ;
      }
      year++;
      $('#yearsPicker').val(year);
  }

}

//获得某月的最后一天
function getLastDay(year,month) {
  return new Date(year,month,0).getDate();
}

// 日统计&&月统计&&年统计
function changeDayMonthYear(e){
    $(this).addClass("active").siblings().removeClass("active");
    if(e.target.id=="days"){
        $('.wrap-title-second').addClass('hide');//日统计不显示人工自动站
        $(".wrap-content>*:eq(0)").removeClass("hide").siblings().addClass("hide");
        $('#daysPicker').val(DateToday('days'));
        initTable0();
        flag=0;
    }else if(e.target.id=="months"){
        $('.wrap-title-second').removeClass('hide');
        $(".wrap-content>*:eq(1)").removeClass("hide").siblings().addClass("hide");
        $('.wrap-title-second button:last-child').addClass('active').siblings().removeClass('active');
        $('#monthsPicker').val(DateToday('months'));
        // $("#gbox_rainfallTable1,#rainfallTable1").remove();
        // if ($("#gbox_rainfallTable0").length) {
        //     $("#gbox_rainfallTable0").after("<table id='rainfallTable1' class='rainfallTable hide'></table>");
        // }else {
        //     $("#rainfallTable0").after("<table id='rainfallTable1' class='rainfallTable hide'></table>");
        // }
        initTable1();
        flag=1;
    }else if(e.target.id=="years"){
        $('.wrap-title-second').removeClass('hide');
        $(".wrap-content>*:eq(2)").removeClass("hide").siblings().addClass("hide");
        $('.wrap-title-second button:last-child').addClass('active').siblings().removeClass('active');
        $('#yearsPicker').val(DateToday('years'));
        initTable2();
        flag=2;
    }
    var idx=$(this).index();
    $('.pickerBox .timePicker').eq($(this).index()).removeClass('hide').siblings('.timePicker').addClass('hide');

    setLeftAndRightTimeStatus(flag);
}

// 切换 自动站 or 人工站
function changeAutoAndArti(){
    $(this).addClass("active").siblings().removeClass("active");
    if ($("#months").hasClass("active")) {
        refreshMonthData();
    }else{
        refreshYearData();
    }
}

//datetimepicker上一项下一项
function changeTime(){

    if($(this)[0].className.indexOf("prevButton")!==-1){
        if (flag === 2) {
            datePrev(2);
            // initTable2();
            refreshYearData();
        }else if(flag === 1){
            datePrev(1);
            // initTable1();
            refreshMonthData();
        }else{
            datePrev(0);
            // initTable0();
            refreshDayData();
        }
        $(".nextButton").addClass("active");
    }else{
        if (flag === 2) {
            dateNext(2);
            // initTable2();
            refreshYearData();
            setLeftAndRightTimeStatus();
        }else if(flag === 1){
            dateNext(1);
            // initTable1();
            refreshMonthData();
            setLeftAndRightTimeStatus();
        }else{
            dateNext(0);
            // initTable0();
            refreshDayData();
            setLeftAndRightTimeStatus();
        }
    }
}

// 设置datetimepicker左右按钮状态
function setLeftAndRightTimeStatus(){
    var thisDate = new Date();
    var todayNumber = thisDate.getDate();
    var tomonthNumber = thisDate.getMonth()+1;
    var toyearNumber = thisDate.getFullYear();
    var arr = $('.pickerBox input').not(".hide").val().split("-");

    $(".nextButton").removeClass("active");
    if (flag === 2) { //年
        if (Number(arr[0]) < toyearNumber) {
            $(".nextButton").addClass("active");
        }
    }else if (flag === 1) {  //月份
        if (Number(arr[0]) < toyearNumber) {
            $(".nextButton").addClass("active");
        }else if(Number(arr[0]) === toyearNumber){
            if (Number(arr[1]) < tomonthNumber) {
                $(".nextButton").addClass("active");
            }
        }
    }else{  //日
        if (Number(arr[0]) < toyearNumber) {
            $(".nextButton").addClass("active");
        }else if(Number(arr[0]) === toyearNumber){
            if (Number(arr[1]) < tomonthNumber) {
                $(".nextButton").addClass("active");
            }else if(Number(arr[1]) === tomonthNumber){
                if (Number(arr[2]) < todayNumber) {
                    $(".nextButton").addClass("active");
                }
            }
        }
    }
}

function initTable0(){
    var sendData = getPrevDate("daysPicker");
    $.ajax({
        url: getDayRainInfoUrl,
        type: 'post',
        dataType: 'json',
        data: {
            days: sendData,
        },
        success: function(result){
            if (result.status === 0) {
                var data = result.data;
                if (data === null) {
                    data = [];
                }
                var arrName = ["测站编码","测站名称",'合计',"8时","9时","10时","11时","12时","13时","14时","15时","16时","17时","18时","19时","20时","21时","22时","23时","0时","1时","2时","3时","4时","5时","6时","7时"];
                var arrModel = [
                    {name: 'sys_code',align:'center',width:260,sortable: false},
                    {name: 'station_name',align:'center',width:260,sortable:false},
                    {name: 'total',align:'center',sortable:false},
                    {name: '8',align:'center',sortable:false},
                    {name: '9',align:'center',sortable:false},
                    {name: '10',align:'center',sortable:false},
                    {name: '11',align:'center',sortable:false},
                    {name: '12',align:'center',sortable:false},
                    {name: '13',align:'center',sortable:false},
                    {name: '14',align:'center',sortable:false},
                    {name: '15',align:'center',sortable:false},
                    {name: '16',align:'center',sortable:false},
                    {name: '17',align:'center',sortable:false},
                    {name: '18',align:'center',sortable:false},
                    {name: '19',align:'center',sortable:false},
                    {name: '20',align:'center',sortable:false},
                    {name: '21',align:'center',sortable:false},
                    {name: '22',align:'center',sortable:false},
                    {name: '23',align:'center',sortable:false},
                    {name: '0',align:'center',sortable:false},
                    {name: '1',align:'center',sortable:false},
                    {name: '2',align:'center',sortable:false},
                    {name: '3',align:'center',sortable:false},
                    {name: '4',align:'center',sortable:false},
                    {name: '5',align:'center',sortable:false},
                    {name: '6',align:'center',sortable:false},
                    {name: '7',align:'center',sortable:false}
                ];
                $.jgrid.defaults.responsive = false;
                $.jgrid.defaults.styleUI = 'Bootstrap';
                console.log(data);
                $("#rainfallTable0").jqGrid({
                    datatype: 'local',
                    data: data,
                    colNames: arrName,
                    colModel: arrModel,
                    autowidth: true,  //自适应宽度
                    loadonce: true,
                    shrinkToFit: true,
                    height: 'auto',
                    emptyrecords: '空',
                    altRows:false,
                    loadComplete: function(){
                        console.log("complete");
                    }
                });
            }
        }
    });
}
function refreshDayData(){
    var sendData = getPrevDate("daysPicker");
    $.ajax({
        url: getDayRainInfoUrl,
        type: 'post',
        dataType: 'json',
        data: {
            days: sendData,
        },
        success: function(result){
            var newData = result.data;
            if (newData === null) {
                newData = [];
            }
            console.log(newData);
            $('#rainfallTable0').jqGrid('clearGridData').jqGrid('setGridParam', {data: newData, datatype: 'local'}).trigger('reloadGrid');
        }
    });
}

function initTable1(){
    $.ajax({
        url: getMonthRainInfoUrl,
        type: 'post',
        dataType: 'json',
        data: {
            month: $("#monthsPicker").val(),
            type: $(".wrap-title-second .active").data("type")
        },
        success: function(result){
            if (result.status === 0) {
                var data = result.data;
                if (data === null) {
                    data = [{}];
                }
                var arrName = ["测站编码","测站名称",'合计',"1日","2日","3日","4日","5日","6日","7日","8日","9日","10日","11日","12日","13日","14日","15日","16日","17日","18日","19日","20日","21日","22日","23日","24日","25日","26日","27日","28日","29日","30日","31日"];
                var arrModel = [
                    {name: 'sys_code',align:'center',width:360,sortable: false},
                    {name: 'station_name',align:'center',width:360,sortable:false},
                    {name: 'total',align:'center',sortable:false},
                    {name: '1',align:'center',sortable:false},
                    {name: '2',align:'center',sortable:false},
                    {name: '3',align:'center',sortable:false},
                    {name: '4',align:'center',sortable:false},
                    {name: '5',align:'center',sortable:false},
                    {name: '6',align:'center',sortable:false},
                    {name: '7',align:'center',sortable:false},
                    {name: '8',align:'center',sortable:false},
                    {name: '9',align:'center',sortable:false},
                    {name: '10',align:'center',sortable:false},
                    {name: '11',align:'center',sortable:false},
                    {name: '12',align:'center',sortable:false},
                    {name: '13',align:'center',sortable:false},
                    {name: '14',align:'center',sortable:false},
                    {name: '15',align:'center',sortable:false},
                    {name: '16',align:'center',sortable:false},
                    {name: '17',align:'center',sortable:false},
                    {name: '18',align:'center',sortable:false},
                    {name: '19',align:'center',sortable:false},
                    {name: '20',align:'center',sortable:false},
                    {name: '21',align:'center',sortable:false},
                    {name: '22',align:'center',sortable:false},
                    {name: '23',align:'center',sortable:false},
                    {name: '24',align:'center',sortable:false},
                    {name: '25',align:'center',sortable:false},
                    {name: '26',align:'center',sortable:false},
                    {name: '27',align:'center',sortable:false},
                    {name: '28',align:'center',sortable:false},
                    {name: '29',align:'center',sortable:false,hidden:false},
                    {name: '30',align:'center',sortable:false,hidden:false},
                    {name: '31',align:'center',sortable:false,hidden:false}
                ];

                var arrDate = $("#monthsPicker").val().split("-");
                var lastDate = dateLast(arrDate[0], arrDate[1]);
                if (lastDate === 29) {
                    arrModel[34].hidden = arrModel[33].hidden = arrModel[32].hidden = true;
                }else if(lastDate === 30){
                    arrModel[34].hidden = arrModel[33].hidden = true;
                }else if(lastDate === 31){
                    arrModel[31].hidden = false;
                }

                $.jgrid.defaults.responsive = false;
                $.jgrid.defaults.styleUI = 'Bootstrap';
                $("#rainfallTable1").jqGrid({
                    datatype: "local",
                    data: data,
                    colNames: arrName,
                    colModel: arrModel,
                    autowidth: true,  //自适应宽度
                    loadonce: true,
                    shrinkToFit: true,
                    height: 'auto',
                    viewrecords: true,
                    emptyrecords: '空',
                    altRows:false,
                });
            }
        }
    });
}
function refreshMonthData(){
    $.ajax({
        url: getMonthRainInfoUrl,
        type: 'post',
        dataType: 'json',
        data: {
            month: $("#monthsPicker").val(),
            type: $(".wrap-title-second .active").data("type")
        },
        success: function(result){
            var newData = result.data;
            if (newData === null) {
                newData = [];
            }
            $('#rainfallTable1').jqGrid('clearGridData').jqGrid('setGridParam', {data: newData, datatype: 'local'}).trigger('reloadGrid');
            // 处理月份
            var arrDate = $("#monthsPicker").val().split("-");
            var lastDate = dateLast(arrDate[0], arrDate[1]);
            if (lastDate === 30) {
                $("#rainfallTable1").showCol("29").showCol("30").hideCol("31").trigger("reloadGrid");
            }else if(lastDate === 29){
                $("#rainfallTable1").showCol("29").hideCol("30").hideCol("31").trigger("reloadGrid");
            }else if(lastDate === 28){
                $("#rainfallTable1").hideCol("29").hideCol("30").hideCol("31").trigger("reloadGrid");
            }else{
                $("#rainfallTable1").showCol("29").showCol("30").showCol("31").trigger("reloadGrid");
            }
        }
    });
}

function initTable2(){
    $.ajax({
        url: getYearRainInfoUrl,
        type: 'post',
        dataType: 'json',
        data: {
            year: $("#yearsPicker").val(),
            type: $(".wrap-title-second .active").data("type")
        },
        success: function(result){
            if (result.status === 0) {
                var data = result.data;
                if (data === null) {
                    data = [];
                }
                    var arrName = ["测站编码","测站名称",'合计',"1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];
                    var arrModel = [
                        {name: 'sys_code',align:'center',width:138,sortable: false},
                        {name: 'station_name',align:'center',width:138,sortable:false},
                        {name: 'total',align:'center',sortable:false},
                        {name: 'Jan',align:'center',sortable:false},
                        {name: 'Feb',align:'center',sortable:false},
                        {name: 'Mar',align:'center',sortable:false},
                        {name: 'Apr',align:'center',sortable:false},
                        {name: 'May',align:'center',sortable:false},
                        {name: 'Jun',align:'center',sortable:false},
                        {name: 'Jul',align:'center',sortable:false},
                        {name: 'Aug',align:'center',sortable:false},
                        {name: 'Sep',align:'center',sortable:false},
                        {name: 'Octb',align:'center',sortable:false},
                        {name: 'Nov',align:'center',sortable:false},
                        {name: 'Dece',align:'center',sortable:false}
                    ];
                    $.jgrid.defaults.responsive = false;
                    $.jgrid.defaults.styleUI = 'Bootstrap';
                    // $("#rainfallTable2").jqGrid("clearGridData");
                    $("#rainfallTable2").jqGrid({
                        datatype: "local",
                        data: result.data,
                        colNames: arrName,
                        colModel: arrModel,
                        autowidth: true,  //自适应宽度
                        loadonce: true,
                        shrinkToFit: true,
                        height: 'auto',
                        viewrecords: true,
                        emptyrecords: '空',
                        altRows:false,
                    });
            }
        }
    });
}
function refreshYearData(){
    $.ajax({
        url: getYearRainInfoUrl,
        type: 'post',
        dataType: 'json',
        data: {
            year: $("#yearsPicker").val(),
            type: $(".wrap-title-second .active").data("type")
        },
        success: function(result){
            var newData = result.data;
            if (newData === null) {
                newData = [];
            }
            console.log(newData);
            $('#rainfallTable2').jqGrid('clearGridData').jqGrid('setGridParam', {data: newData, datatype: 'local'}).trigger('reloadGrid');
        }
    });
}

// 6:自动站 7:人工站
$(function(){
	//初始化日期控件
    $('#daysPicker').val(DateToday('days'));
    setLeftAndRightTimeStatus();
    // 日统计&&月统计&&年统计
    $(".wrap-title-first>button").on("click",changeDayMonthYear);
    // 人工站&&自动站
    $(".wrap-title-second>button").on("click",changeAutoAndArti);

    //左右按钮切换日期 存在问题
    $(".pickerBox").on("click",".prevButton.active,.nextButton.active",changeTime);

    // 导出到excel文件
    $(".wrap-title-forth>button").on("click",function(){
        var str = $(".wrap-title-third .pickerBox>input:not(.hide)").val();
        $(".rainfallTable").not(".hide").jqGrid('exportToExcel', {
            includeLabels: true,
            includeGroupHeader: true,
            includeFooter: true,
            fileName: "雨量统计报表"+str+".xlsx",
            mimetype: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            maxlength: 40,
            onBeforeExport: null,
            replaceStr: null
        });
    });


    initTable0();
});
