var successReturn=0;
//左侧导航栏切换
function changeLeftNav(){
		$(this).addClass('active').siblings().removeClass('active');
		$('.rightContent').eq($(this).index()).removeClass('hide').siblings().addClass('hide');
		if($(this).hasClass('left-item1')){
			console.log('第一页面');
		}else if($(this).hasClass('left-item2')){
			getStationList();

		}else if($(this).hasClass('left-item3')){
			console.log('第三页面');
		}else if($(this).hasClass('left-item4')){
			console.log('第四页面');
			getAreaList();
		}
		setLeftHeight();
}

/**测站信息管理列表**/
function getStationList(){
	var stationListNoContent=$('.rightContent2 .notContent');
	var stationList=$('.rightContent2 .right-table-body-dataBind');
	$.ajax({
		url:getStationListUrl,
		type:"get",
		data:{},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				var stationAjaxList=result.data;
				if(null != stationAjaxList && stationAjaxList.length == 0){
					stationListNoContent.removeClass('hide');
					stationList.addClass('hide');
				}else if(null != stationAjaxList){
					stationList.removeClass('hide');
					stationListNoContent.addClass('hide');
					stationList.render(stationAjaxList);

					$('#create').on("click",createStationModal);
					$('.rightContent2 .right-body-table').off('click').on('click','.editBox',function(){
						editStationModal(this);
					});

					setLeftHeight();
				}
			}else{
				outBoxClose(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}
var isFirst=true;
function editStationModal(e){
	$('#editStationForm').removeClass('hide').prev().addClass('hide');
	$('#createStation').modal('show');
	$('#createStation').on('shown.bs.modal',function(){
		//创建和修改 地图只创建一次
			if(isFirst){
	    		 Map.init(true);
	    		 isFirst=false;
	    	}


	});
	editStation($(e));

 }
//新建测站弹窗
function createStationModal(){
	$('#createStationForm').removeClass('hide').next().addClass('hide');
	$('#createStationForm .errorB').html('');
	$("#createStation").modal("show");

	$('#createStation').on('shown.bs.modal',
	    function() {
	    	if(isFirst){
	    		 Map.init(true);
	    		 isFirst=false;
	    	}

	    	getTypeList();//获取测站类型
	    	getListOfArea();//获取区域
		});

		$('#createStationSave').off('click').on('click',function(){
	    		createStation();
	    })

}
//修改测站
function editStation(e){

	var stationId=e.parents('.right-table-row').first().find('.content2RowId').val();
	//调用getStationInfoDetailUrl
	$.ajax({
		url:getStationInfoDetailUrl,
		type:"get",
		data:{stationId:stationId},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				var stationInfo=result.data;
				if(null != stationInfo && stationInfo.length == 0){

				}else if(null != stationInfo){

					$('#editStationForm').render(stationInfo);

					getTypeList(stationInfo.station_type_id);//获取当前站测站类型
			    	getListOfArea(stationInfo.area_id);//获取当前站区域
			    	// $('#editStationForm select').attr('disabled','disabled');
			    	$('#editStationSave').off('click').on('click',function(){
			    		updateStationInfo(stationId);
			    	});

				}
			}else{
				outBoxClose(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}
//新建测站弹窗查询测站类型列表
function getTypeList(flag){
	$.ajax({
		url:getTypeListUrl,
		type:"get",
		data:{},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){

				result.data.unshift({
					"sta_type_id": 0,
					"type_name": "--请选择--"
				});
				var typeAjaxList=result.data;
				if(null != typeAjaxList && typeAjaxList.length == 0){

				}else if(null != typeAjaxList){

					var typeAjaxListVal={
						type_name:{
							value:function(){
								return this.sta_type_id;
							}
						}
					};
					$('#createStation-type-picker,#editStation-type-picker').render(typeAjaxList,typeAjaxListVal);
					$('#createStation-type-picker option:first,#editStation-type-picker option:first').attr('disabled',true);

					if(flag){
						$('#editStation-type-picker').selectpicker('val',flag);
						$('#editStation-type-picker').selectpicker('refresh');
					}else{
						$('#createStation-type-picker').selectpicker('val','');
						$('#createStation-type-picker').selectpicker('refresh');
					}

				}

			}else{
				outBoxClose(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}
//新建测站弹窗查询区域列表
function getListOfArea(flag){
	$.ajax({
		url:getListOfAreaUrl,
		type:"get",
		data:{},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				result.data.unshift({
					"area_id": 0,
					"area_name": "--请选择--"
				});
				var getListOfArea=result.data;
				if(null != getListOfArea && getListOfArea.length == 0){

				}else if(null != getListOfArea){
					var getListOfAreaVal={
						area_name:{
							value:function(){
								return this.area_id;
							}
						}
					};
					$('#createArea-picker,#editArea-picker').render(getListOfArea,getListOfAreaVal);
					$('#createArea-picker option:first,#editArea-picker option:first').attr('disabled',true);
					if(flag){
						$('#editArea-picker').selectpicker('val',flag);
						$('#editArea-picker').selectpicker('refresh');
					}else{
						$('#createArea-picker').selectpicker('val','');
						$('#createArea-picker').selectpicker('refresh');
					}

				}
			}else{
				outBoxClose(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}
/**测站信息管理-新建测站**/
function createStation(){
	//获取新建测站用户填写数据发送后后台

	// var stationType=$('#station-type-picker  option:selected').val();
	// var area=$('#area-picker  option:selected').val();

	// console.log(stationType,area);
	//表单校验
	var station_name=$('input[name="station_name"]').val();//测站名称
	var sys_code=$('input[name="sys_code"]').val();//测站名系统编码
	var stcd=$('input[name="stcd"]').val();//国家标准码
	var x=$('input[name="x"]').val();//横坐标
	var y=$('input[name="y"]').val();//纵坐标
	var station_location=$('input[name="station_location"]').val();//站址
	var type_name=$('.station-type-picker .dropdown-menu li.selected').attr('data-original-index');//测站类型
	var area_name=$('.area-picker .dropdown-menu li.selected').attr('data-original-index');//区域
	var comments=$('textarea[name="comments"]').val();//备注

	 if(!$.trim(station_name)||!$.trim(sys_code)||!$.trim(stcd)||!$.trim(x)||!$.trim(y)||!$.trim(station_location)||!$.trim(type_name)||!$.trim(area_name)||!$.trim(comments)){
            errorInfo();
            return false;
    }else{
		$.ajax({
			url:createStationUrl,
			type:"post",
			data:$("#createStationForm").serialize(),
			dataType:"json",
			success:function(result){
				if(successReturn == result.status){
					$('#createStation').modal('hide');
					getStationList();
				}else{
					outBoxClose(result.msg);
				}
			},
			error:function(XMLHttpRequest){
				// error_500(XMLHttpRequest.responseText);
			}
		});    	
    }
}
/**修改保存更新当前站信息**/
function updateStationInfo(stationId){
	var station_type_id=$('#editStation-type-picker option:selected').val();
	var area_id=$('#editArea-picker option:selected').val();
	$.ajax({
		url:updateStationInfoUrl,
		type:"post",
		data:$("#editStationForm").serialize()+"&id="+stationId+"&station_type_id="+station_type_id+"&area_id="+area_id,
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				$('#createStation').modal('hide');
				getStationList();

			}else{
				outBoxClose(result.msg);
			}
		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}
function errorInfo(){
		$("#createStationForm .stationNameError").html('测站名称不能为空');
		$("#createStationForm .sysCodeError").html('测站名系统编码不能为空');
		$("#createStationForm .stcdError").html('国家标准码不能为空');
		$("#createStationForm .xError").html('横坐标不能为空');
		$("#createStationForm .yError").html('纵坐标不能为空');
		$("#createStationForm .stationLocationError").html('站址不能为空');
		$("#createStationForm .stationTypeError").html('测站类型不能为空');
		$("#createStationForm .areaError").html('区域不能为空');
		$("#createStationForm .commentsError").html('备注不能为空');
}


/*页面3 and 页面4 - 显示更多信息*/
function showAreaCard(e){
	var id = $(e.target).parents(".right-table-row-item").find("[data-bind=area_id]").val();
	$.ajax({
		url: getAreaDetailInfoUrl,
		type: 'get',
		data: {areaId: id},
		success: function(result){
			if (result.status === 0){
				var data = result.data;
				var areaName = (data.algorithmType===0)?"算数平均法":"系数平均法";
				var sentence2 = "2. "+data.area_name+"按照"+areaName+"计算平均雨量；";
				$("#areaCard p:eq(1)").text(sentence2);
				/*显示并处理弹窗的位置*/
				var position = $(e.target).offset();
				var left = position.left-27;
				var top = position.top+28 ;
				$("#right .areaCard").css({
					"left":left,
					"top":top
				}).removeClass("hide");
			}else {
				/*显示错误信息弹窗*/
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
	e.stopPropagation();
}
/*页面3 and 页面4 - 隐藏更多信息*/
function hideAreaCard(evt){
	if($(evt.target).parents(".areaCard").length==0){
		$('.areaCard').addClass('hide');
	}
}

/* 页面3 - 算法管理 */
function showAverageRainfall(){
	$("#averageRainfall").modal("show");
	$(".modify").on("click",function(){
		$("#averageRainfallModify").modal("show");
		//仅保留一个背景颜色
		$(".modal-backdrop").css("opacity",0);
		$(".modal-backdrop")[0].style.opacity = 0.3;
	});
}
/* 页面3 - 算法管理: 修改 */
function showAverageRainfallModify(){
	$("#averageRainfallModify").modal("show");
	//仅保留一个背景颜色
	$(".modal-backdrop").css("opacity",0);
	$(".modal-backdrop")[0].style.opacity = 0.3;
}
/*第4页 - 查询显示区域列表*/
function getAreaList(){
	$.ajax({
		url:getListOfAreaUrl,
		type:'get',
		success: function(result){
			if (result.status === 0) {
				$(".rightContent4 .right-table-body-dataBind").render(result.data);
				setLeftHeight();
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

/* 页面4 - 修改区域 - 显示*/
function modifyArea(e){
	$("#createField .modal-content").data("type",1);  /*0:新建区域; 1:修改区域*/
	var id = $(e.target).parents(".right-table-row").find("[data-bind=area_id]").val();
	$.ajax({
		url:getAreaDetailInfoUrl,
		type:'get',
		data:{
			areaId: id
		},
		dataType: 'json',
		success: function(result){
			if (result.status === 0) {
				$("#createField form")[0].reset();  //清空form
				$("#createField .modal-header>span").text("修改-测报数据");  //更换表头名称
				$("#createField .modal-body-item:eq(0) input").val(result.data.area_name);  //form填入数据
				$("#createField").modal("show");  //显示出弹窗
				console.log(result.data);
			}else{
				/*显示错误信息弹窗*/
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}
/* 页面4 - 新建区域&修改区域 - 保存*/
function saveAreaInfo(){
	//判断是 新建(0) or 修改(1)
	if ($("#createField .modal-content").data("type") === 0) {
		console.log("新建");
		$.ajax({
			url: createAreaUrl,
			type: 'post',
			data: $("#createField form").serialize(),
			// data: {
			// 	"area_name": "我是名字",
			// 	"comment": "评论内容"
			// },
			dataType: 'json',
			success: function(result){
				if (result.status === 0) {
					$("#createField").modal("hide");
					$(".left-item4").trigger("click");
				}else{
					console.log(result.msg);
				}
			},
			error: function(XMLHttpRequest){
				// error_500(XMLHttpRequest.responseText);
			}
		});
	}else {
		console.log("修改");
	}

}

/*设置页面高度*/
function setLeftHeight(){
	// 1. 先清除高度
	$("#left").height("");
	$("#right").height("");
	// 2. 获取高度,用于比较
	var heightLeft= $("#left").outerHeight(true);
	var heightRight= $("#right").outerHeight(true);
	// 3. 比较并赋值
	if (heightLeft > heightRight) {
		// 动态获取margin和padding值
		var rightMt = parseInt($("#right").css("marginTop"));
		var rightMb = parseInt($("#right").css("marginBottom"));
		var rightPt = parseInt($("#right").css("paddingTop"));
		var rightBt = parseInt($("#right").css("paddingBottom"));
		$("#right").height(heightLeft-rightMt-rightMb-rightPt-rightBt);
	}else{
		$("#left").height(heightRight);
	}
}

$(function(){
	setLeftHeight();

	$('.left-item').on("click",changeLeftNav);
	/**自动测报数据修补tabs切换**/
	$('.rightContent1 .btn-tabs button').on("click",function(){
		$(this).addClass('active').siblings().removeClass('active');
	});
	/**增补**/
	$('#augment').on("click",function(){
 		$("#augmentModal").modal("show");
	})
	/**测站信息管理**/

	$('#create').off('click').on('click',function(){
		createStationModal();
	});

	/* 页面3 and 页面4 - 显示更多信息 */
	$(".rightContent3 .right-table-body,.rightContent4 .right-table-body").on("click","i.introself",showAreaCard);
	/* 页面3 - 隐藏更多信息 */
	$(document).on("click",hideAreaCard);

	/* 页面3 - 算法管理 */
	$(".rightContent3 .create").on("click",showAverageRainfall);
	/* 页面3 - 算法管理: 修改 */
	$("#averageRainfall li.modify").on("click",showAverageRainfallModify);
	/* 页面3 - 算法管理 - 修改: 切换测站 */
	$("#averageRainfallModify .rainfall-item3 .rainfall-right>div").on("click",function(){
		$(this).toggleClass("active");
	});


	/**页面4 - 区域信息管理**/
	/* 新建区域 - 显示*/
	$(".rightContent4 .create").on("click",function(){
		$("#createField .modal-content").data("type",0);  /*0:新建区域; 1:修改区域*/
		$("#createField .modal-header>span").text("增补-测报数据");  //更换表头名称
		$("#createField form")[0].reset();  //清空form
		$("#createField").modal("show");
	});
	/*新建区域&修改区域 - 保存*/
	$("#createField button.save").on("click",saveAreaInfo);
	/* 修改区域 - 显示*/
	$(".rightContent4 .right-table-body").on("click",".modify",modifyArea);

});
