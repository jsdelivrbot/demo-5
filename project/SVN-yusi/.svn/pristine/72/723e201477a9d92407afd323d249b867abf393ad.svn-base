var successReturn=0;
var time_off=1;//拍报段次默认为1
var isFirst=true;
var wmsIsFirst=true;
//左侧导航栏切换
function changeLeftNav(){
		$(this).addClass('active').siblings().removeClass('active');
		$('.rightContent').eq($(this).index()).removeClass('hide').siblings().addClass('hide');
		if($(this).hasClass('left-item1')){//自动测报数据修补
			initDateTimePicker("content1Starttime","content1Endtime");
		}else if($(this).hasClass('left-item2')){//自动站信息管理
			getAutomaticStationList(6);

		}else if($(this).hasClass('left-item3')){//人工站信息管理
			getartificialStationList(7);
		}else if($(this).hasClass('left-item4')){//区域平均降雨
			// 初始化时间插件
			initDateTimePicker("content3Starttime","content3Endtime");
			// 获取数据
			getAverageRainList();
		}else if($(this).hasClass('left-item5')){//区域信息管理
			console.log('第五页面');
			getAreaList();
		}
		setLeftHeight();
}
//拍报段次
function sectionItemChange(){
	$('.sectionItem ').off('click').on('click',function(){
		$(this).addClass('active').siblings().removeClass('active');
		time_off=$(this).find('span').html();
	});
}

/**自动站信息管理列表**/
function getAutomaticStationList(station_type){
	var stationListNoContent=$('.rightContent2 .notContent');
	var stationList=$('.rightContent2 .right-table-body-dataBind');
	$.ajax({
		url:getStationListUrl,
		type:"get",
		data:{
			station_type:station_type
		},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				var stationAjaxList=result.data;
				if(null != stationAjaxList && stationAjaxList.length == 0){
					stationListNoContent.removeClass('hide');
					stationList.addClass('hide');
				}else if(null != stationAjaxList){
					stationList.removeClass('hide');
					stationListNoContent.addClass('hide');
					stationList.render(stationAjaxList);

					$('#create').on("click",createStationModal);
					$('.rightContent2 .right-body-table').off('click').on('click','.editBox',function(){
						editStationModal(this);
					});

					setLeftHeight();
				}
			}else{
				errorBox(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

//自动站新建测站弹窗
function createStationModal(){
	$('#createStationForm').removeClass('hide').next().addClass('hide');
	$('#createStation .modal-header>span').html('新建测站');
	$('#createStationForm input').html('');
	$('#createStationForm .errorB').html('');
	getTypeList();//获取测站类型
	getListOfArea();//获取区域
	$("#createStation").modal("show");

	$('#createStation').on('shown.bs.modal',
	    function() {
	    	if(isFirst){
	    		 Map.init(true,'map');
	    		 isFirst=false;
	    	}
		});
		//切换拍报段次
		sectionItemChange();

		$('#createStationSave').off('click').on('click',function(){
	    	automaticCreateStation(time_off);
	    });

}

/**自动站信息管理-新建测站**/
function automaticCreateStation(){
	//获取新建测站用户填写数据发送后后台
	$('.errorB').html('');

	// var stationType=$('#station-type-picker  option:selected').val();
	// var area=$('#area-picker  option:selected').val();

	// console.log(stationType,area);
	//表单校验
	var station_name=$('input[name="station_name"]').val();//测站名称
	var sys_code=$('input[name="sys_code"]').val();//测站名系统编码
	var stcd=$('input[name="stcd"]').val();//国家标准码
	var x=$('input[name="x"]').val();//横坐标
	var y=$('input[name="y"]').val();//纵坐标
	var station_location=$('input[name="station_location"]').val();//站址
	var type_name=$('.station-type-picker .dropdown-menu li.selected').attr('data-original-index');//测站类型
	var area_name=$('.area-picker .dropdown-menu li.selected').attr('data-original-index');//区域
	var comments=$('textarea[name="comments"]').val();//备注

	 // if(!errorInfo(station_name,sys_code,stcd,x,y,station_location,type_name,area_name,comments)){
	 // 	console.log('前端校验');
  //   }else{
		$.ajax({
			url:createStationUrl,
			type:"post",
			data:$("#createStationForm").serialize()+"&time_off="+time_off+"&station_type=6",
			dataType:"json",
			success:function(result){
				if(successReturn == result.status){
					$('#createStation').modal('hide');
					outBoxClose('创建成功');
					getAutomaticStationList('6');
				}else{
					errorBox(result.msg);
				}
			},
			error:function(XMLHttpRequest){
				// error_500(XMLHttpRequest.responseText);
			}
		});
     // }
}

//自动站修改测站弹窗
function editStationModal(e){
	$('#editStationForm').removeClass('hide').prev().addClass('hide');
	$('input[type="text"]').val('');//清空横纵坐标以及清除地图上点
	$('#createStation').modal('show');
	$('#createStation .modal-header>span').html('修改测站');
	$('#createStation').on('shown.bs.modal',function(){
		//创建和修改 地图只创建一次
		if(isFirst){
    		 Map.init(true,'map');
    		 isFirst=false;
    	}
	});
	editStation($(e));

 }

//修改测站
function editStation(e){

	var stationId=e.parents('.right-table-row').first().find('.content2RowId').val();
	//调用getStationInfoDetailUrl
	$.ajax({
		url:getStationInfoDetailUrl,
		type:"get",
		data:{stationId:stationId},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				var stationInfo=result.data;
				if(null != stationInfo && stationInfo.length == 0){

				}else if(null != stationInfo){
					time_off=stationInfo.time_off;
					if(time_off=="1"){
						$('.sectionItem'+time_off).addClass('active').siblings().removeClass('active');
					}else if(time_off=="2"){
						$('.sectionItem'+time_off).addClass('active').siblings().removeClass('active');
					}else if(time_off=="4"){
						$('.sectionItem'+time_off).addClass('active').siblings().removeClass('active');
					}else if(time_off=="6"){
						$('.sectionItem'+time_off).addClass('active').siblings().removeClass('active');
					}
					$('#editStationForm').render(stationInfo);

					getTypeList(stationInfo.station_type_id);//获取当前站测站类型
			    	getListOfArea(stationInfo.area_id);//获取当前站区域

			    	//切换拍报段次
					sectionItemChange();
			    	$('#editStationSave').off('click').on('click',function(){
			    		updateStationInfo(stationId,time_off);
			    	});
				}
			}else{
				errorBox(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

/**修改保存更新当前站信息**/
function updateStationInfo(stationId,time_off){
	// var station_type_id=$('#editStation-type-picker option:selected').val();
	// var area_id=$('#editArea-picker option:selected').val();
	$.ajax({
		url:updateStationInfoUrl,
		type:"post",
		data:$("#editStationForm").serialize()+"&id="+stationId+"&time_off="+time_off,
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				$('#createStation').modal('hide');
				outBoxClose('修改成功');
				getAutomaticStationList('6');

			}else{
				errorBox(result.msg);
			}
		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}

//新建测站弹窗查询测站类型列表
function getTypeList(flag){
	$.ajax({
		url:getTypeListUrl,
		type:"get",
		data:{},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){

				result.data.unshift({
					"sta_type_id": 0,
					"type_name": "--请选择--"
				});
				var typeAjaxList=result.data;
				if(null != typeAjaxList && typeAjaxList.length == 0){

				}else if(null != typeAjaxList){

					var typeAjaxListVal={
						type_name:{
							value:function(){
								return this.sta_type_id;
							}
						}
					};
					//自动站
					$('#createStation-type-picker,#editStation-type-picker').render(typeAjaxList,typeAjaxListVal);
					$('#createStation-type-picker option:first,#editStation-type-picker option:first').attr('disabled',true);

					//人工站
					$('#createWmsStation-type-picker,#editWmsStation-type-picker').render(typeAjaxList,typeAjaxListVal);
					$('#createWmsStation-type-picker option:first,#editWmsStation-type-picker option:first').attr('disabled',true);

					if(flag){//编辑
						$('#editStation-type-picker').selectpicker('val',flag);//自动站编辑测站类型
						$('#editStation-type-picker').selectpicker('refresh');

						$('#editWmsStation-type-picker').selectpicker('val',flag);//人工站站编辑测站类型
						$('#editWmsStation-type-picker').selectpicker('refresh');

					}else{
						$('#createStation-type-picker').selectpicker('val','');//自动站编新建站类型
						$('#createStation-type-picker').selectpicker('refresh');
						$('#createWmsStation-type-picker').selectpicker('val','');//人工站新建测站类型
						$('#createWmsStation-type-picker').selectpicker('refresh');
					}

				}

			}else{
				errorBox(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}
//新建测站弹窗查询区域列表
//flag 是否编辑
function getListOfArea(flag){
	$.ajax({
		url:getListOfAreaUrl,
		type:"get",
		data:{},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				result.data.unshift({
					"area_id": 0,
					"area_name": "--请选择--"
				});
				var getListOfArea=result.data;
				console.log(getListOfArea);
				if(null != getListOfArea && getListOfArea.length == 0){

				}else if(null != getListOfArea){
					var getListOfAreaVal={
						area_name:{
							value:function(){
								return this.area_id;
							}
						}
					};
					//自动站
					$('#createArea-picker').render(getListOfArea,getListOfAreaVal);//自动站新建区域
					$('#createArea-picker option:first').attr('disabled',true);

					//人工站

					$('#createWmsArea-picker').render(getListOfArea,getListOfAreaVal);//人工站新建区域
					$('#createWmsArea-picker option:first').attr('disabled',true);					

					// $('#createWmsArea-picker,#editWmsArea-picker').render(getListOfArea,getListOfAreaVal);
					// $('#createWmsArea-picker option:first,#editWmsArea-picker option:first').attr('disabled',true);					

					// $('#createWmsArea-picker,#editWmsArea-picker').render(getListOfArea,getListOfAreaVal);
					// $('#createWmsArea-picker option:first,#editWmsArea-picker option:first').attr('disabled',true);

					if(flag){//编辑
						var obj = {};
						if(flag=="1"){
							obj.area_name='上游';
							obj.area_id=1;
						}else if(flag=="2"){
							obj.area_name='中游';
							obj.area_id=2;
						}else if(flag=="3"){
							obj.area_name='下游';
							obj.area_id=3;
						}else if(flag=="4"){
							obj.area_name='全库';
							obj.area_id=4;
						}
						
						$('#AwsArea').render(obj);//
						$('#wmsArea').render(obj);

						
						//自动站
						// $('#editArea-picker').selectpicker('val',flag);
						// $('#editArea-picker').selectpicker('refresh');

						//人工站

						// $('#editWmsArea-picker').selectpicker('val',flag);
						// $('#editWmsArea-picker').selectpicker('refresh');						

					}else{
						//自动站
						$('#createArea-picker').selectpicker('val','');//自动站新建区域
						$('#createArea-picker').selectpicker('refresh');

						//人工站
						$('#createWmsArea-picker').selectpicker('val','');//人工站新建区域
						$('#createWmsArea-picker').selectpicker('refresh');
					}

				}
			}else{
				errorBox(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}


function errorInfo(station_name,sys_code,stcd,x,y,station_location,type_name,area_name,comments){

	//测站名系统编码,国家标准码不需要做非空判断
	$('.errorB').html('');
	if($.trim(station_name)==""){
		$("#createStationForm .stationNameError").html('测站名称不能为空');
		return false;
	}

	if(sys_code.length>8){
		$("#createStationForm .sysCodeError").html('测站名系统编码不能超过8位');
		return false;
	}

	if(stcd.length>12){
		$("#createStationForm .stcdError").html('国家标准码不能超过12位');
		return false;
	}
	if($.trim(x)==""){
		$("#createStationForm .xError").html('横坐标不能为空');
		return false;
	}
	if($.trim(y)==""){
		$("#createStationForm .yError").html('纵坐标不能为空');
		return false;
	}
	if($.trim(station_location)==""){
		$("#createStationForm .stationLocationError").html('站址不能为空');
		return false;
	}
	if($.trim(type_name)=="0"){
		$("#createStationForm .stationTypeError").html('测站类型不能为空');

		return false;
	}
	if($.trim(area_name)=="0"){
		$("#createStationForm .areaError").html('区域不能为空');
		return false;
	}
	return true;

}
//后台校验
function errorInfoII(msg){
	if(msg=="横坐标不能为空"){
		$("#createStationForm .xError").html(msg);
	}
	if(msg=="纵坐标不能为空"){
		$("#createStationForm .yError").html(msg);
	}
	if(msg=="请选择测站类型"){
		$("#createStationForm .stationTypeError").html(msg);
	}
	if(msg=="请选择区域"){
		$("#createStationForm .areaError").html(msg);
	}
	if(msg=="请输入测站名称"){
		$("#createStationForm .stationNameError").html(msg);
	}
	if(msg=="请输入8位测站标准码"){
		$("#createStationForm .sysCodeError").html(msg);
	}
	if(msg=="请输入12位国家标准码"){
		$("#createStationForm .stcdError").html(msg);
	}
	if(msg=="测站名称已存在"){
		$("#createStationForm .stationNameError").html(msg);
	}
}

/*人工站信息管理*/
function getartificialStationList(station_type){
	var stationListNoContent=$('.rightContent3 .notContent');
	var stationList=$('.rightContent3 .right-table-body-dataBind');
	$.ajax({
		url:getStationListUrl,
		type:"get",
		data:{
			station_type:station_type
		},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				var stationAjaxList=result.data;
				if(null != stationAjaxList && stationAjaxList.length == 0){
					stationListNoContent.removeClass('hide');
					stationList.addClass('hide');
				}else if(null != stationAjaxList){
					stationList.removeClass('hide');
					stationListNoContent.addClass('hide');
					stationList.render(stationAjaxList);

					$('#create').on("click",createStationModal);
					$('.rightContent3 .right-body-table').off('click').on('click','.editBox',function(){
						editWmsStationModal(this);
					});

					setLeftHeight();
				}
			}else{
				errorBox(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

//人工站新建测站弹窗
function createWmsStationModal(isFirst){
	$('#createWmsStationForm').removeClass('hide').next().addClass('hide');
	$('#createWmsStation .modal-header>span').html('新建测站');
	$('#createWmsStationForm input').html('');
	$('#createWmsStationForm .errorB').html('');
	$('input[type="text"]').val('');//清空横纵坐标
	getTypeList();//获取测站类型
	getListOfArea();//获取区域
	$("#createWmsStation").modal("show");

	$('#createWmsStation').on('shown.bs.modal',

	    function() {

	    	if(wmsIsFirst){
	    		 Map.init(true,'map1');
	    		 wmsIsFirst=false;
	    	}

		});
		//切换拍报段次
		sectionItemChange();

		$('#createWmsStationSave').off('click').on('click',function(){
	    	createWmsStation(time_off);
	    });

}

/**人工站信息管理-新建测站**/
function createWmsStation(time_off){
	//获取新建测站用户填写数据发送后后台
	$('.errorB').html('');

	// var stationType=$('#station-type-picker  option:selected').val();
	// var area=$('#area-picker  option:selected').val();

	// console.log(stationType,area);
	//表单校验
	var station_name=$('input[name="station_name"]').val();//测站名称
	var sys_code=$('input[name="sys_code"]').val();//测站名系统编码
	var stcd=$('input[name="stcd"]').val();//国家标准码
	var x=$('input[name="x"]').val();//横坐标
	var y=$('input[name="y"]').val();//纵坐标
	var station_location=$('input[name="station_location"]').val();//站址
	var type_name=$('.station-type-picker .dropdown-menu li.selected').attr('data-original-index');//测站类型
	var area_name=$('.area-picker .dropdown-menu li.selected').attr('data-original-index');//区域
	var comments=$('textarea[name="comments"]').val();//备注

	 // if(!errorInfo(station_name,sys_code,stcd,x,y,station_location,type_name,area_name,comments)){
	 // 	console.log('前端校验');
  //   }else{
		$.ajax({
			url:createStationUrl,
			type:"post",
			data:$("#createWmsStationForm").serialize()+"&time_off="+time_off+"&station_type=7",
			dataType:"json",
			success:function(result){
				if(successReturn == result.status){
					$('#createWmsStation').modal('hide');
					outBoxClose('创建成功');
					getartificialStationList('7');
				}else{
					errorBox(result.msg);
				}
			},
			error:function(XMLHttpRequest){
				// error_500(XMLHttpRequest.responseText);
			}
		});
     // }
}


//人工站修改测站弹窗
function editWmsStationModal(e){
	$('#editWmsStationForm').removeClass('hide').prev().addClass('hide');
	$('#createWmsStation').modal('show');
	$('#createWmsStation .modal-header>span').html('修改测站');
	$('#createWmsStation').on('shown.bs.modal',function(){
		//创建和修改 地图只创建一次
		if(wmsIsFirst){
    		 Map.init(true,'map1');
    		 wmsIsFirst=false;
    	}

	});
	editWmsStation($(e));

 }

//人工站修改测站
function editWmsStation(e){

	var stationId=e.parents('.right-table-row').first().find('.content2RowId').val();
	//调用getStationInfoDetailUrl
	$.ajax({
		url:getStationInfoDetailUrl,
		type:"get",
		data:{stationId:stationId},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				var stationInfo=result.data;
				if(null != stationInfo && stationInfo.length == 0){

				}else if(null != stationInfo){
					time_off=stationInfo.time_off;
					if(time_off=="1"){
						$('.sectionItem'+time_off).addClass('active').siblings().removeClass('active');
					}else if(time_off=="2"){
						$('.sectionItem'+time_off).addClass('active').siblings().removeClass('active');
					}else if(time_off=="4"){
						$('.sectionItem'+time_off).addClass('active').siblings().removeClass('active');
					}else if(time_off=="6"){
						$('.sectionItem'+time_off).addClass('active').siblings().removeClass('active');
					}
					$('#editWmsStationForm').render(stationInfo);

					getTypeList(stationInfo.station_type_id);//获取当前站测站类型
			    	getListOfArea(stationInfo.area_id);//获取当前站区域

			    	//切换拍报段次
					sectionItemChange();
			    	$('#editWmsStationSave').off('click').on('click',function(){
			    		updateWmsStationInfo(stationId,time_off);
			    	});
				}
			}else{
				errorBox(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

/**人工站修改保存更新当前站信息**/
function updateWmsStationInfo(stationId,time_off){
	// var station_type_id=$('#editStation-type-picker option:selected').val();
	// var area_id=$('#editArea-picker option:selected').val();

	$.ajax({
		url:updateStationInfoUrl,
		type:"post",
		data:$("#editWmsStationForm").serialize()+"&id="+stationId+"&time_off="+time_off,
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				$('#createWmsStation').modal('hide');
				outBoxClose('修改成功');
				getartificialStationList(7);

			}else{
				errorBox(result.msg);
			}
		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}


/**区域平均降雨列表**/
function getAverageRainList(){
	var beginTime = $("#content3Starttime").val();
	var endTime = $("#content3Endtime").val();
	//计算[降雨历时]
	var durationTime = Date.parse(endTime) - Date.parse(beginTime);
	var h = parseInt(durationTime/(60*60*1000),10);
	var m = parseInt(durationTime%(60*60*1000)/(60*1000),10);
	m = (m<10)?"0"+m:m;
	durationTime = h+"小时"+m+"分钟";

	$.ajax({
		url: areaAverageRainfallUrl,
		type: 'post',
		data: {
			begin_time: beginTime,
			end_time: endTime
		},
		dataType: 'json',
		success: function(result){
			// 添加[降雨历时] + 保留1位小数 + 无数据填"——";
			if (result.data) {
				result.data.forEach(function(val,index){
					// if (val.average_rainfall) {
					// 	val.average_rainfall = val.average_rainfall.toFixed(1);
					// 	val.max_Rainfall = val.max_Rainfall.toFixed(1);
					// }

					if (!val.station_info_list) {
						val.average_rainfall=val.maxStation=val.max_Rainfall = "——";
					}

					val.durationTime = durationTime;
				});

				var averageRainfall = {
					maxStation: {
						"data-stationid": function(){
							return this.maxStation_id;
						}
					},
				};

				$(".rightContent4 .right-table-body-dataBind").render(result.data,averageRainfall);
				setLeftHeight();
			}else {
				errorBox("无内容");
			}
		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

/* 页面3 - 算法管理 */
function showAverageRainfall(){
	var beginTime = $("#content3Starttime").val();
	var endTime = $("#content3Endtime").val();

	$.ajax({
		url: areaAverageRainfallUrl,
		type: 'post',
		data: {
			begin_time: beginTime,
			end_time: endTime
		},
		dataType: 'json',
		success: function(result){
			if (result.data) {
				var data = result.data;
				data.forEach(function(val,index){
					// 添加计算方法
					val.area_method = (val.algorithmType===0)?"算术平均法":"系数平均法";
					if (val.station_info_list) {
						val.station_info_list.forEach(function(subVal,index){
							// 系数平均法: 添加系数值 + 隐藏算术平均法项
							if (val.algorithmType === 1) {
								val.param_list.forEach(function(subsubVal){
									if (subsubVal.param_staId===subVal.id) {
										subVal.param_value = subsubVal.param_value;
										subVal.param_hide = "";
									}
								});
							}else {
								subVal.param_value = "";
								subVal.param_hide = "hide";
							}
						});
					}
				});
				// console.log(data);
				var algorithmManage = {
					area_name: {
						"data-areaId": function(){
							return this.area_id;
						}
					},
					station_info_list: {
						param_value: {
							class: function(){
								return this.param_hide;
							}
						},
						station_name: {
							"data-stationid": function(){
								return this.id;
							}
						}
					}
				};

				$("#averageRainfall .modal-body-content").render(result.data,algorithmManage);
				setLeftHeight();

				$("#averageRainfall").modal("show");
			}else{
				errorBox(result.msg);
			}
		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});


}

/* 页面3 - 算法管理: 修改 */
function showAverageRainfallModify(){

	$.ajax({
		url: getAreaStationParamListUrl,
		type: 'get',
		data:{area_id: $(this).parents("ul").find("[data-bind=area_name]").data("areaid")},
		dataType: 'json',
		success: function(result){
			// console.log(result);
			if (result.status === successReturn) {
				var data = result.data;
				var renderData = {
					areaId: data[0].area_id,
					areaName: data[0].area_name,
					stationData: data,
					stationParam: (function(){
						/*设置系数填充信息*/
						var str=[];
						if (data[0].param) {
							data.forEach(function(val){
								str.push(val.param);
							});
							str = str.join("-");
						}
						return str;
					})(data)
				};
				var renderDataProperty = {
					areaName: {
						'data-areaId': function(){
							return this.areaId;
						}
					},
					stationData: {
						station_name: {
							'data-stationId': function(){
								return this.sta_id;
							}
						}
					}
				};
				// console.log(renderData);
				$("#averageRainfallModify form").render(renderData,renderDataProperty);

				if (data[0].hasOwnProperty("param")) {
					$("#averageRainfallModify .rainfall-right-second").trigger("click");
					$("#averageRainfallModify .rainfall-item4 .errorInfo").text("");
				}else {
					$("#averageRainfallModify .rainfall-right-first").trigger("click");
				}

				$("#averageRainfallModify").modal("show");
				//仅保留一个背景颜色
				$(".modal-backdrop").css("opacity",0);
				$(".modal-backdrop")[0].style.opacity = 0.3;
			}else {
				errorBox(result.msg);
			}
		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

/* 页面3 - 算法管理: 修改: 切换测站 */
function averageRainfallModifyChange(){
	$(this).addClass("active").siblings().removeClass("active");
	if ($("#averageRainfallModify .rainfall-right-first").hasClass("active")) {
		$("#averageRainfallModify .rainfall-item4").addClass("hide");
	}else {
		$("#averageRainfallModify .rainfall-item4").removeClass("hide");
		$("#averageRainfallModify .rainfall-item4 .errorInfo").text("");
	}
}

/* 页面3 - 算法管理: 修改:保存 */
function averageRainfallModifySave(){
	// 验证系数之和等于1
	var stationParam = $("#averageRainfallModify [data-bind=stationParam]").val();
	var $errorBox = $("#averageRainfallModify .rainfall-item4 .errorInfo");
	// 检测是否填写了内容
	if (stationParam.length) {
		stationParam = stationParam.split("-");
		var stationNumber = $("#averageRainfallModify [data-bind=station_name]").length;
		// 检测填写的系数数量是否正确
		if (stationParam.length === stationNumber) {
			var sum = 0;
			stationParam.forEach(function(val,i){
				sum += Number(val);
			});
			if (Math.abs(sum-1) < 1e-6) {
				var param = {};  //定义传送的数据;
				var areaId = $("#averageRainfallModify [data-bind=areaName]").data("areaid");
                param.area_id = areaId;  //构建传送数据
                param.analysis_type=$("#averageRainfallModify .rainfall-right-first").hasClass("active")?0:1;  //构建传送数据

				var paramList = [];  //定义系数数组
				var station = $("#averageRainfallModify [data-bind=station_name]");
				$.each(station,function(i,val){
					var item = {};
					item.area_id = areaId;
					item.sta_id = parseInt(val.dataset.stationid,10);
					if (param.analysis_type === 0) {
						item.param = null;
					}else {
						item.param = stationParam[i];
					}
					paramList.push(item);
				});
                param.paramList = paramList;  //构建传送数据

				$.ajax({
					url: analysisManagerUrl,
					type: 'POST',
					traditional: true,
                    contentType : 'application/json;charset=utf-8',
					data: JSON.stringify(param),
					dataType: 'json',
					success: function(result){
						if (result.status === successReturn) {
							$("#averageRainfallModify .closeImg").trigger("click");
							$(".rightContent4 .create").trigger("click");
						}else {
							errorBox(result.msg);
						}
					},
					error: function(XMLHttpRequest){
						// error_500(XMLHttpRequest.responseText);
					}
				});

			}else{
				$errorBox.text("系数之和不等于1");
			}

		}else {
			$errorBox.text("测站个数和系数个数不相等");
		}
	}else{
		$errorBox.text("请填写系数");
	}
	$("[data-bind=stationParam]").focus(function(){$errorBox.text("")});
}

/*页面3 显示更多信息*/
function showAreaCard(e){
	$("#right .areaCard").addClass("hide");
	var id = $(e.target).parents(".right-table-row-item").find("[data-bind=area_id]").val();
	var sentence1="",sentence2="";
	//处理sentence1
	var beginTime = $("#content3Starttime").val();
	var endTime = $("#content3Endtime").val();
	$.ajax({
		url: areaAverageRainfallUrl,
		type: 'post',
		data: {
			begin_time: beginTime,
			end_time: endTime
		},
		dataType: 'json',
		success: function(result){
			if (result.data) {
				result.data.forEach(function(val,index){
					if (val.area_id == id) {
						var stationList = val.station_info_list;
						if (stationList==null) {
							sentence1 = "1. "+val.area_name+val.message.slice(3)+"；";
						}else {
							sentence1 = "1. "+val.area_name+"共包括"+stationList.length+"个雨量站：";
							stationList.forEach(function(subVal,i){
								sentence1 += subVal.station_name+"、";
							});
							sentence1 = sentence1.slice(0,-1)+"；";
						}
						$("#areaCard p:eq(0)").text(sentence1);
					}
				});

				//处理sentence2
				$.ajax({
					url: getAreaDetailInfoUrl,
					type: 'get',
					data: {areaId: id},
					success: function(result){
						if (result.status === successReturn){
							var data = result.data;
							var areaName = (data.algorithmType===0)?"算数平均法":"系数平均法";
							sentence2 = "2. "+data.area_name+"按照"+areaName+"计算平均雨量；";
							$("#areaCard p:eq(1)").text(sentence2);

							/*显示并处理弹窗的位置*/
							var position = $(e.target).offset();
							var left = position.left-27;
							var top = position.top+28 ;
							$("#right .areaCard").css({
								"left":left,
								"top":top
							}).removeClass("hide");
						}else {
							errorBox(result.msg);
						}
					},
					error: function(XMLHttpRequest){
						// error_500(XMLHttpRequest.responseText);
					}
				});
			}else {
				errorBox(result.msg);
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
	e.stopPropagation();
}

/*页面3 - 隐藏更多信息*/
function hideAreaCard(evt){
	if($(evt.target).parents(".areaCard").length==0){
		$('.areaCard').addClass('hide');
	}
}


/*第4页 - 查询显示区域列表*/
function getAreaList(){
	$.ajax({
		url:getListOfAreaUrl,
		type:'get',
		success: function(result){
			if (result.status === successReturn) {
				$(".rightContent5 .right-table-body-dataBind").render(result.data);
				setLeftHeight();
			}else {
				errorBox(result.msg);
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

/* 页面4 - 新建区域&修改区域 - 显示*/
function createAndModifyArea(e){
	// 点击对象不是modify代表新建
	if ( $(this)[0].className != "modify" ) {
		$("#createField .modal-content").data("type",0).data("areaId","");  /*0:新建区域; 1:修改区域; 清空areaId*/
		$("#createField .modal-header>span").text("增补-测报数据");  //更换表头名称
		$("#createField input,#createField textarea").val("");  //清空form
		$("#createField").modal("show");
	}else {
		var id = $(e.target).parents(".right-table-row").find("[data-bind=area_id]").val();
		$("#createField .modal-content").data("type",1).data("areaId",id);  /*0:新建区域; 1:修改区域; 设置areaId*/
		$.ajax({  /*查询站信息*/
			url:getAreaDetailInfoUrl,
			type:'get',
			data:{
				areaId: id
			},
			dataType: 'json',
			success: function(result){
				if (result.status === successReturn) {
					$("#createField form")[0].reset();  //清空form
					$("#createField .modal-header>span").text("修改-测报数据");  //更换表头名称
					$("#createField form").render(result.data);  //form填入数据
					$("#createField").modal("show");  //显示出弹窗
				}else{
					errorBox(result.msg);
				}
			},
			error: function(XMLHttpRequest){
				// error_500(XMLHttpRequest.responseText);
			}
		});
	}
}
/* 页面4 - 新建区域&修改区域 - 保存*/
function saveAreaInfo(e){
	//判断是 新建(0) or 修改(1)
	if ($("#createField .modal-content").data("type") === 0) {
		$.ajax({
			url: createAreaUrl,
			type: 'post',
			data: $("#createField form").serialize(),
			dataType: 'json',
			success: function(result){
				if (result.status === successReturn) {
					$("#createField").modal("hide");
					$(".left-item4").trigger("click");
				}else{
					errorBox(result.msg);
				}
			},
			error: function(XMLHttpRequest){
				// error_500(XMLHttpRequest.responseText);
			}
		});
	}else {
		$.ajax({
			url: updateAreaInfoUrl,
			type: 'post',
			data: {
				area_id: $("#createField .modal-content").data("areaId"),
				area_name: $("#createField input[name=area_name]").val(),
				comment: $("#createField textarea[name=comment]").val(),
			},
			dataType: 'json',
			success: function(result){
				if (result.status === successReturn) {
					$("#createField .closeImg").trigger("click");
					$(".left-item4").trigger("click");
				}else {
					errorBox(result.msg);
				}
			},
			error: function(XMLHttpRequest){
				// error_500(XMLHttpRequest.responseText);
			}
		});
	}
}

/*设置页面高度*/
function setLeftHeight(){
	// 1. 先清除高度
	$("#left").height("");
	$("#right").height("");
	// 2. 获取高度,用于比较
	var heightLeft= $("#left").outerHeight(true);
	var heightRight= $("#right").outerHeight(true);
	// 3. 比较并赋值
	if (heightLeft > heightRight) {
		// 动态获取margin和padding值
		var rightMt = parseInt($("#right").css("marginTop"));
		var rightMb = parseInt($("#right").css("marginBottom"));
		var rightPt = parseInt($("#right").css("paddingTop"));
		var rightBt = parseInt($("#right").css("paddingBottom"));
		$("#right").height(heightLeft-rightMt-rightMb-rightPt-rightBt);
	}else{
		$("#left").height(heightRight);
	}
}

$(function(){
	setLeftHeight();
	/*初始化第一页时间插件*/
	initDateTimePicker("content1Starttime","content1Endtime");

	$('.left-item').on("click",changeLeftNav);
	/**自动测报数据修补tabs切换**/
	$('.rightContent1 .btn-tabs button').on("click",function(){
		$(this).addClass('active').siblings().removeClass('active');
	});
	/**增补**/
	$('#augment').on("click",function(){
 		$("#augmentModal").modal("show");
	});
	/**自动站新建测站**/

	$('#create').off('click').on('click',function(){
		createStationModal();
	});
	/**手动站新建测站**/
	$('#wmsCreate').off('click').on('click',function(){
		createWmsStationModal(isFirst);
	});
	/**页面3 - 平均区域降雨**/
	/*获取区域平均降雨信息*/
	$("#rightContent4_search_btn").on("click",getAverageRainList);
	/* 显示更多信息 */
	$(".rightContent4 .right-table-body").on("click","i.introself",showAreaCard);
	/* 隐藏更多信息 */
	$(document).on("click",hideAreaCard);

	/* 算法管理 */
	$(".rightContent4 .create").on("click",showAverageRainfall);
	/* 算法管理: 修改 */
	$("#averageRainfall .modal-body-content").on("click","div.modifyson",showAverageRainfallModify);
	/* 算法管理 - 修改: 切换测站 */
	$("#averageRainfallModify .rainfall-item3 .rainfall-right>div").on("click",averageRainfallModifyChange);
	$("#averageRainfallModify .saveAverageRainfall").on("click",averageRainfallModifySave);

	/**页面4 - 区域信息管理**/
	/* 新建区域 - 显示*/
	$(".rightContent5 .create").on("click",createAndModifyArea);
	/* 修改区域 - 显示*/
	$(".rightContent5 .right-table-body").on("click",".modify",createAndModifyArea);
	/*新建区域&修改区域 - 保存*/
	$("#createField button.save").on("click",saveAreaInfo);

});
