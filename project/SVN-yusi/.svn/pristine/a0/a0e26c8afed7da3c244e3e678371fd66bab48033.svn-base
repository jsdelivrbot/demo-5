<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
    "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatisPro.myBatisDao.AllDataCMapper">

	<!-- 获取所有待整编数据 -->
	<select id="getAllDateInfo" resultType="mybatisPro.mybatisEntity.AllDataCEntity" useCache="false">
		SELECT * FROM st_alldata_c 
		<if test="max_id!=null">
	   		WHERE  id &gt; #{max_id}  <!-- AND id &lt; 71584 -->
	   	</if>
	    
	</select>
	
	<!-- 获取最大ID值 -->
	<select id="getMaxId" resultType="long" useCache="false">
		select MAX(id) from st_alldata_c
	</select>
	
	<!-- 获取去重后数据ID -->
	<select id="getDistinctId" resultType="long" useCache="false">
		SELECT MAX(id) AS id FROM st_alldata_c  WHERE id>#{max_id}  GROUP BY paraid,collecttime
	</select>
	
	<!-- 重复数据处理状态（已处理） -->
	<update id="updateUndistincInfo">
		UPDATE st_alldata_c SET is_reorganize=1 WHERE id  IN
		<foreach collection="id_info" index="index" item="item"  open="("  separator=","  close=")">
			#{item}
		</foreach>
	</update>
	
	<update id="updateMaxFlag">
		UPDATE st_alldata_c SET max_flag=1 WHERE id=#{id} 
	</update>
	
	<update id="updateMaxFlagFalse">
		UPDATE st_alldata_c SET max_flag=0 WHERE id  IN
		<foreach collection="id_info" index="index" item="item"  open="("  separator=","  close=")">
			#{item}
		</foreach>
	</update>
	
	<!-- 获取水库水位信息 -->
	<select id="getRsvDataInfo"  resultType="mybatisPro.mybatisEntity.WzRiverRsvrEntity" useCache="false">
		SELECT
		   st_alldata_c.`collecttime` AS TIME,
		   MAX(st_alldata_c.id) AS data_id,
		   ParamId_StationId.`sta_id` AS sta_id,
		   FORMAT((IFNULL(paravalue,0)+IFNULL(corvalue,0)),2) AS waterLevel
		FROM
    		`rwdb`.`st_alldata_c`
    	INNER JOIN `rwdb`.`ParamId_StationId` 
        	ON (`st_alldata_c`.`paraid` = `ParamId_StationId`.`param_id`)
    	INNER JOIN `rwdb`.`ST_BS_STBPRP_B` 
       		ON (`ParamId_StationId`.`sta_id` = `ST_BS_STBPRP_B`.`id`)
		WHERE 
			SUBSTRING(st_alldata_c.`paraid`,9,4)='0003' AND
			<if test="type=='2'.toString()">
				ST_BS_STBPRP_B.`station_type_id`=2 
			</if>
			<if test="type=='3'.toString()">
				ST_BS_STBPRP_B.`station_type_id`=3
			</if>
			AND is_reorganize=0
		GROUP BY 
			st_alldata_c.paraid,st_alldata_c.collecttime
	</select>
	
	<!-- 获取雨量数据信息 -->
	<select id="getRainDataInfo" 	resultType="mybatisPro.mybatisEntity.RpPptnEntity" useCache="false">
		SELECT
			  st_alldata_c.`collecttime` AS time,
			  MAX(st_alldata_c.id) AS data_id,
			  ParamId_StationId.`sta_id` AS sta_id,
			  st_alldata_c.paravalue AS paravalue,
			  st_alldata_c.systemtime AS systemtime,
			  st_alldata_c.collecttime AS collecttime
		FROM
    		`rwdb`.`st_alldata_c`
   		INNER JOIN `rwdb`.`ParamId_StationId` 
        	ON (`st_alldata_c`.`paraid` = `ParamId_StationId`.`param_id`)
    	INNER JOIN `rwdb`.`ST_BS_STBPRP_B` 
       		ON (`ParamId_StationId`.`sta_id` = `ST_BS_STBPRP_B`.`id`)
		WHERE 
			SUBSTRING(st_alldata_c.`paraid`,9,4)='0004' AND ST_BS_STBPRP_B.`station_type_id`=1 AND ST_BS_STBPRP_B.`id`=#{sta_id}
			<if test="collecttime!=null">
				AND st_alldata_c.collecttime  &gt; #{collecttime}
			</if>
			 AND is_reorganize=0
	    GROUP BY 
			st_alldata_c.paraid,st_alldata_c.collecttime
		ORDER BY
		    st_alldata_c.collecttime DESC
	</select>
	
	<select id="getStaId" resultType="long" useCache="false">
		SELECT 
			DISTINCT(ParamId_StationId.`sta_id`) 
	    FROM 
			st_alldata_c 
	    INNER JOIN ParamId_StationId 
			ON (`st_alldata_c`.`paraid` = `ParamId_StationId`.`param_id`)
	    WHERE
			SUBSTRING(st_alldata_c.`paraid`,9,4)='0004'
	</select>
	
	<!-- 数据导入 -->
	<insert id="insertAllDateInfo"  parameterType="java.util.List" >
		 INSERT IGNORE INTO st_alldata_c(
		 	`id`, `paraid`, `paravalue`, `change`, `collecttime`, `systemtime`, `channelnum`, `flag`
		 )
		  VALUES 
		 <foreach collection="data_info" index="index" item="item"  separator="," >
			 (
				 #{item.id},#{item.paraid},#{item.paravalue},#{item.change},#{item.collecttime},
				 #{item.systemtime},#{item.channelnum},#{item.flag}
			 )
		</foreach>
	</insert>
	
	<!-- 更新数据处理状态 -->
	<update id="updateUndistincInfos" parameterType="java.util.List" >
		UPDATE st_alldata_c SET is_reorganize=1 WHERE id &lt; #{max_id}
	</update>
	
	<!-- 获取雨量水位实时数据ID -->
	<select id="getRiverRsvrDataId" resultType="long">
		SELECT 
  			st_alldata_c.id AS data_id
		FROM
		  	`rwdb`.`st_alldata_c` 
		  INNER JOIN `rwdb`.`ParamId_StationId` 
		    ON (
		      `st_alldata_c`.`paraid` = `ParamId_StationId`.`param_id`
		    ) 
		  INNER JOIN `rwdb`.`ST_BS_STBPRP_B` 
		    ON (
		      `ParamId_StationId`.`sta_id` = `ST_BS_STBPRP_B`.`id`
		    ) 
		WHERE
			 SUBSTRING(st_alldata_c.`paraid`, 9, 4) = '0003' AND
			 <if test="type=='2'.toString()">
				ST_BS_STBPRP_B.`station_type_id`=2 
			</if>
			<if test="type=='3'.toString()">
				ST_BS_STBPRP_B.`station_type_id`=3
			</if>
			  AND is_reorganize = 0
	</select>
	
	<select id="getRainDataId" resultType="long">
		 SELECT  
			  st_alldata_c.id AS data_id 
		FROM
    		`rwdb`.`st_alldata_c`
   		INNER JOIN `rwdb`.`ParamId_StationId` 
        	ON (`st_alldata_c`.`paraid` = `ParamId_StationId`.`param_id`)
    	INNER JOIN `rwdb`.`ST_BS_STBPRP_B` 
       		ON (`ParamId_StationId`.`sta_id` = `ST_BS_STBPRP_B`.`id`)
		WHERE 
			SUBSTRING(st_alldata_c.`paraid`,9,4)='0004' AND ST_BS_STBPRP_B.`station_type_id`=1 AND ST_BS_STBPRP_B.`id`=#{sta_id}
			<if test="collecttime!=null">
				AND st_alldata_c.collecttime  &gt; #{collecttime}
			</if>
			AND is_reorganize=0
	</select>
	
	<!-- 获取各个雨量站最大collecttime -->
	<select id="getMaxRainCollectTime" resultType="map">
		SELECT 
  			st_alldata_c.`collecttime` AS collect_time,
  			st_alldata_c.`paravalue` AS para_value
		FROM
			  st_alldata_c 
			  INNER JOIN `rwdb`.`ParamId_StationId` 
			    ON (
			      `st_alldata_c`.`paraid` = `ParamId_StationId`.`param_id`
			    ) 
		WHERE sta_id = #{sta_id} AND max_flag=1
	</select>
	
	<select id="getMaxCollectTimeId" resultType="long">
		SELECT id FROM st_alldata_c WHERE max_flag=1
	</select>
	
	

</mapper>