var successReturn=0;
var dropDownIdx=0;
var dropDonMenuLength;
var sta_id;//保存站id
var typeFlag='1';//记录类型
var begin_time=getBeforeDate(1);//默认近24小时
var end_time=getNowDate();//获取现在的日期

//获取现在时间
function getNowDate(){
 	var d = new Date();
    var year = d.getFullYear();
    var mon=d.getMonth()+1;
    var day=d.getDate();
    var hours=d.getHours();
    var minutes=d.getMinutes();
    return s = year+"-"+(mon<10?('0'+mon):mon)+"-"+(day<10?('0'+day):day)+" "+(hours<10?('0'+hours):hours)+":"+(minutes<10?('0'+minutes):minutes);
}

/**获取今天前24小时,7天,30天**/
function getBeforeDate(n){
    var n = n;
    var d = new Date();
    var year = d.getFullYear();
    var mon=d.getMonth()+1;
    var day=d.getDate();
    var hours=d.getHours();
    var minutes=d.getMinutes();

    if(day <= n){
	    if(mon>1) {
	     mon=mon-1;
	    }else {
	     year = year-1;
	     mon = 12;
	    }
    }
	d.setDate(d.getDate()-n);
	year = d.getFullYear();
	mon=d.getMonth()+1;
	day=d.getDate();
    return s = year+"-"+(mon<10?('0'+mon):mon)+"-"+(day<10?('0'+day):day)+" "+(hours<10?('0'+hours):hours)+":"+(minutes<10?('0'+minutes):minutes);

}
//获得年月日 
function getMyDate(str){  
    var oDate = new Date(str),  
    oYear = oDate.getFullYear(),  
    oMonth = oDate.getMonth()+1,  
    oDay = oDate.getDate(),  
    oHour = oDate.getHours(),  
    oMin = oDate.getMinutes(),  
   
    oTime = oYear +'-'+ getzf(oMonth) +'-'+ getzf(oDay) +' '+ getzf(oHour) +':'+ getzf(oMin);//最后拼接时间  
    return oTime;  
}; 
//补0操作 
function getzf(num){  
    if(parseInt(num) < 10){  
        num = '0'+num;  
    }  
    return num;  
}  
//获取站名列表刷新右下角表格数据
function getStationNameList(typeFlag){

	console.log(begin_time,end_time);
	$.ajax({
		url:getStationNameListUrl,
		type:'get',
		data: {
			typeFlag:typeFlag
		},
		dataType: 'json',
		success: function(result){
			if (result.status === successReturn) {
				var data = result.data;
				var arr=[];
				if(data){
					var dataProperty={
						station_name:{
							"data-id": function(){
								return this.id;
							}
						}
					};

					$.each(data,function(i,o){
						arr.push(o);
					});
					$('.selectView span').html(arr[0].station_name);//取列表第一个名字
					//$(".selectView span").data('sta_id',arr[0].id);//取列表第一个id保存到自定义属性中
					sta_id=$(".selectView span")[0].dataset.sta_id=arr[0].id;
					//console.log(sta_id);
					$('.dropDonMenu').render(data,dataProperty);
					dropDonMenuLength=$(".dropDonMenu").children("li").length;
				
					if(typeFlag=='0'){//水库水情
						stationChange(dropDonMenuLength,typeFlag);

					}else if(typeFlag=='1'){//河道水情
						stationChange(dropDonMenuLength,typeFlag);
					}

				}

			}else {
				errorBox(result.msg);
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

/**按钮切换**/
function stationChange(dropDonMenuLength,typeFlag){
	dropDownIdx=0;//重置
	typeFlagChange(typeFlag);

	//右侧中部左右切换
	$(".prevButton").off('click').on('click',function(){
		if(dropDownIdx<=dropDonMenuLength-1){
			dropDownIdx--;
			if(dropDownIdx<0){
				dropDownIdx=0;
				$('#prevBtn').attr('disabled',true);
				$('#nextBtn').attr('disabled',false);
				return;
			}else{
				$('#prevBtn').attr('disabled',false);
				$('#nextBtn').attr('disabled',false);
			}
			selectView();
			typeFlagChange(typeFlag);			
		}
		
	});

	$(".nextButton").off('click').on('click',function(){
		if(dropDonMenuLength-dropDownIdx>=0){//总数-当前
			dropDownIdx++;
			if(dropDownIdx>dropDonMenuLength-1){
				dropDownIdx=dropDonMenuLength-1;
				$('#nextBtn').attr('disabled',true);
				$('#prevBtn').attr('disabled',false);	
				return ;
			}else{
				$('#nextBtn').attr('disabled',false);
				$('#prevBtn').attr('disabled',false);	
			}
			selectView();
			typeFlagChange(typeFlag);			
		}
		
	});
	
}

//河道水情echart
function getRiverDataForEcharts(begin_time,end_time,sta_id){
	$.ajax({
		url:getRiverDataForEchartsUrl,
		type:'get',
		data: {
			begin_time:begin_time,
			end_time:end_time,
			sta_id:sta_id			
		},
		dataType: 'json',
		success: function(result){
			if (result.status === successReturn) {
				var data = result.data;
				if(data.length==0){
					errorBox('无数据');
				}else{
					// console.log(result.dataSub);
					var waterData=data[0];
					var storageData=data[1];
					var xAxisData=result.dataSub;
								
					if(xAxisData&&waterData&&storageData){
						$.each(waterData,function(i,o){
							if(null==o){
								waterData[i]=0;
							}
						});

						$.each(storageData,function(i,o){
							if(null==o){
								storageData[i]=0;
							}
						});								
						lienChart(xAxisData,waterData,storageData);
					}	
				}

			}else {
				errorBox(result.msg);
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});		
}
//水库水情echart
function getResvoirDataForEcharts(begin_time,end_time,sta_id){
	$.ajax({
		url:getResvoirDataForEchartsUrl,
		type:'get',
		data: {
			begin_time:begin_time,
			end_time:end_time,
			sta_id:sta_id			
		},
		dataType: 'json',
		success: function(result){
			if (result.status === successReturn) {
				var data = result.data;
				if(data.length==0){
					errorBox('无数据');
				}else{
					var waterData=data[0];
					var storageData=data[1];
					var xAxisData=result.dataSub;				
					if(xAxisData&&waterData&&storageData){
						$.each(waterData,function(i,o){
							if(null==o){
								waterData[i]=0;
							}
						});

						$.each(storageData,function(i,o){
							if(null==o){
								storageData[i]=0;
							}
						});								
						lienChart(xAxisData,waterData,storageData);
					}
				}

			}else {
				errorBox(result.msg);
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});	

}


//河道水位数据列表
function getRiverDataList(begin_time,end_time,sta_id){
	$.ajax({
		url:getRiverDataListUrl,
		type:'get',
		data: {
			begin_time:begin_time,
			end_time:end_time,
			sta_id:sta_id
		},
		dataType: 'json',
		success: function(result){
			if (result.status === successReturn) {
				var data = result.data;
				if(data.length==0){
					errorBox('无数据');
					$('.data-bind').render(data);
				}else{
					$.each(data,function(i,o){
						if(null==o.rateOfFlow||null==o.waterLevel){
							o.rateOfFlow="—";
							o.waterLevel="—";
							
						}
						o.time=getMyDate(o.time);
					});
					// console.log(data);
					$('.data-bind').render(data);
				}
			}else {
				errorBox(result.msg);
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

//水库水位数据列表
function getResvoirDataList(begin_time,end_time,sta_id){
	$.ajax({
		url:getResvoirDataListUrl,
		type:'get',
		data: {
			begin_time:begin_time,
			end_time:end_time,
			sta_id:sta_id
		},
		dataType: 'json',
		success: function(result){
			if (result.status === successReturn) {
				var data = result.data;
				if(data.length==0){
					errorBox('无数据');
					$('.data-bind').render(data);
				}else{
					$.each(data,function(i,o){
						if(null==o.rateOfFlow||null==o.waterLevel){
							o.rateOfFlow="—";
							o.waterLevel="—";
							
						}
						o.time=getMyDate(o.time);
					});
					//console.log(data);
					$('.data-bind').render(data);
				}
			}else {
				errorBox(result.msg);
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}

//赋值 ID
function selectView(){
	$(".selectView span").html($(".dropDonMenu li").eq(dropDownIdx).html());
	sta_id=$(".selectView span")[0].dataset.sta_id=$(".dropDonMenu li").eq(dropDownIdx)[0].dataset.id;	
}

//类型切换列表
function typeFlagChange(typeFlag){
	if(typeFlag=='1'){//河道水情
		getRiverDataList(begin_time,end_time,sta_id);
		getRiverDataForEcharts(begin_time,end_time,sta_id);
	}else if(typeFlag=='0'){//水库水情
		getResvoirDataList(begin_time,end_time,sta_id);
		getResvoirDataForEcharts(begin_time,end_time,sta_id);
	}
}

$(function(){
	initDateTimePicker('content1Starttime','content1Endtime');
	if(typeFlag=="0"){
		getStationNameList('0');//获取水库水情站名列表
	}else if(typeFlag=="1"){
		getStationNameList('1');//获取河道水情站名列表
	}
	
	//左侧菜单切换
	$("#left li").off('click').on('click',function(e){
		$(this).addClass('active').siblings().removeClass('active');
		if($(e.target).hasClass('left-item1')){//河道水情
			$('.btn-tabs button:first').addClass('active').siblings().removeClass('active');
			begin_time=getBeforeDate(1);//初始化为最近24小时
			getStationNameList('1');//获取站名列表,获取右侧表格数据
			typeFlag='1';
			$('#prevBtn').attr('disabled',false);
			$('#nextBtn').attr('disabled',false);

		}else{//水库水情
			$('.btn-tabs button:first').addClass('active').siblings().removeClass('active');
			$('.timepickerBox').addClass('hide');
			begin_time=getBeforeDate(1);//初始化为最近24小时
			getStationNameList('0');//获取站名列表,获取右侧表格数据
			typeFlag='0';
			$('#prevBtn').attr('disabled',false);
			$('#nextBtn').attr('disabled',false);			
		}
	});

	//右侧头部按钮切换
	$(".btn-tabs button").off('click').on('click',function(e){
		$(this).addClass('active').siblings().removeClass('active');
		//控制时间控件是否显示
		if($(e.target).hasClass('btn4')){
			$('.timepickerBox').removeClass('hide');
		}else{
			$('.timepickerBox').addClass('hide');
		}
		//切换日期范围
		if($('.btn-tabs .btn1').hasClass('active')){//近24小时
			begin_time=getBeforeDate(1);
			$('#content1Starttime').val(begin_time);
			typeFlagChange(typeFlag);

		}else if($('.btn-tabs .btn2').hasClass('active')){//近7天
			begin_time=getBeforeDate(7);
			$('#content1Starttime').val(begin_time);
			typeFlagChange(typeFlag);
		}else if($('.btn-tabs .btn3').hasClass('active')){//近30天
			begin_time=getBeforeDate(30);
			$('#content1Starttime').val(begin_time);
			typeFlagChange(typeFlag);
		}
		
	});
	//搜索
	$('#rightContent1_search_btn').on('click',function(){
		begin_time=$('#content1Starttime').val();
		end_time=$('#content1Endtime').val();
		typeFlagChange(typeFlag);

	});
	//交互
	$(".selectView span").on('click',function(){
		$(".dropDonMenu").show();
	});
	$(document).click(function(evt){
		if($(evt.target).parents(".selectBox").length==0){
			$('.dropDonMenu').hide();
		}
	});

	//右侧中部赋值
	$(".dropDonMenu").on('click','li',function(){
		$(".selectView span").html($(this).html());
		dropDownIdx=$(this).index();
		sta_id=$(".selectView span")[0].dataset.sta_id=$(this).attr('data-id');
		$(".dropDonMenu").hide();
		typeFlagChange(typeFlag);
	});

	//lienChart();
    // $(window).resize(function(){
    //     lienChart();
    // });

});
