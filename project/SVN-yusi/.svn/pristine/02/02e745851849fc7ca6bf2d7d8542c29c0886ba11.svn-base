var successReturn=0;
//左侧导航栏切换
function changeLeftNav(){
		$(this).addClass('active').siblings().removeClass('active');
		$('.rightContent').eq($(this).index()).removeClass('hide').siblings().addClass('hide');
		if($(this).hasClass('left-item1')){
			console.log('第一页面');
		}else if($(this).hasClass('left-item2')){
			getStationList();
		}else if($(this).hasClass('left-item3')){
			console.log('第三页面');
		}else if($(this).hasClass('left-item4')){
			console.log('第四页面');
			getAreaList();
		}
		setLeftHeight();
}

/**测站信息管理列表**/
function getStationList(){
	var stationListNoContent=$('.rightContent2 .notContent');
	var stationList=$('.rightContent2 .right-table-body-dataBind');
	$.ajax({
		url:getStationListUrl,
		type:"get",
		data:{},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				var stationAjaxList=result.data;
				if(null != stationAjaxList && stationAjaxList.length == 0){
					stationListNoContent.removeClass('hide');
					stationList.addClass('hide');
				}else if(null != stationAjaxList){
					stationList.removeClass('hide');
					stationListNoContent.addClass('hide');
					stationList.render(stationAjaxList);
					setLeftHeight();
				}
			}else{
				outBoxClose(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}
var isFirst=true;
function createOrEditStation(e){
 		$("#createStation").modal("show");
		 if( $(e.target).attr('id')=="create"){//新建
 			$('#createStation').on('shown.bs.modal',
			    function() {
			    	if(isFirst){
			    		 Map.init(true);
			    		 isFirst=false;
			    	}
			    	getTypeList();//获取测站类型
			    	getListOfArea();//获取区域

			    	$('#createStationSave').click(function(){
			    		createStation();
			    	})
		 		});
		 }else if( $(e.target).attr('id')=="editBox"||$(e.target).attr('id')=="editPic"||$(e.target).attr('id')=="edit"){//编辑

			$('#createStation').on('shown.bs.modal',function(){
				//问题:当新建初始化地图后，修改不在init
		 		editStation(e.target);
			});

		 }
}

function editStation(e){
	var stationId=$(e).parents('.right-table-row').first().find('.content2RowId').val();
	//调用getStationInfoDetailUrl
	$.ajax({
		url:getStationInfoDetailUrl,
		type:"get",
		data:{stationId:stationId},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				var stationInfo=result.data;
				if(null != stationInfo && stationInfo.length == 0){

				}else if(null != stationInfo){
					$('#createStionForm').render(stationInfo);

					getTypeList(stationInfo.station_type_id);//获取当前站测站类型
			    	getListOfArea(stationInfo.area_id);//获取当前站区域
			    	$('#createStationSave').click(function(){
			    		updateStationInfo(stationId);
			    	});

				}
			}else{
				outBoxClose(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}
//新建测站弹窗查询测站类型列表
function getTypeList(flag){
	$.ajax({
		url:getTypeListUrl,
		type:"get",
		data:{},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){

				result.data.unshift({
					"sta_type_id": 0,
					"type_name": "--请选择--"
				});
				var typeAjaxList=result.data;
				if(null != typeAjaxList && typeAjaxList.length == 0){

				}else if(null != typeAjaxList){

					var typeAjaxListVal={
						type_name:{
							value:function(){
								return this.sta_type_id;
							}
						}
					};
					$('#station-type-picker').render(typeAjaxList,typeAjaxListVal);

					if(flag){
						$('#station-type-picker').selectpicker('val',flag);
						$('#station-type-picker').selectpicker('refresh');
					}else{
						$('#station-type-picker').selectpicker('val','');
						$('#station-type-picker').selectpicker('refresh');
					}

				}

			}else{
				outBoxClose(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}
//新建测站弹窗查询区域列表
function getListOfArea(flag){
	$.ajax({
		url:getListOfAreaUrl,
		type:"get",
		data:{},
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				result.data.unshift({
					"area_id": 0,
					"area_name": "--请选择--"
				});
				var getListOfArea=result.data;
				if(null != getListOfArea && getListOfArea.length == 0){

				}else if(null != getListOfArea){
					var getListOfAreaVal={
						area_name:{
							value:function(){
								return this.area_id;
							}
						}
					};
					$('#area-picker').render(getListOfArea,getListOfAreaVal);
					if(flag){
						$('#area-picker').selectpicker('val',flag);
						$('#area-picker').selectpicker('refresh');
					}else{
						$('#area-picker').selectpicker('val','');
						$('#area-picker').selectpicker('refresh');
					}

				}
			}else{
				outBoxClose(result.msg);
			}

		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}
/**测站信息管理-新建测站**/
function createStation(){
	//获取新建测站用户填写数据发送后后台

	var stationType=$('#station-type-picker  option:selected').val();
	var area=$('#area-picker  option:selected').val();

	console.log(stationType,area);
	$.ajax({
			url:createStationUrl,
			type:"post",
			data:$("#createStionForm").serialize(),
			dataType:"json",
			success:function(result){
				if(successReturn == result.status){
					$('#createStation').modal('hide');
					getStationList();
				}else{
					outBoxClose(result.msg);
				}
			},
			error:function(XMLHttpRequest){
				// error_500(XMLHttpRequest.responseText);
			}
		});

}
/**修改保存更新当前站信息**/
function updateStationInfo(stationId){
	$.ajax({
		url:updateStationInfoUrl,
		type:"post",
		data:$("#createStionForm").serialize()+"&id="+stationId,
		dataType:"json",
		success:function(result){
			if(successReturn == result.status){
				$('#createStation').modal('hide');
				getStationList();

			}else{
				outBoxClose(result.msg);
			}
		},
		error:function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});

}


/*页面3 and 页面4 - 显示更多信息*/
function showAreaCard(e){
	var position = $(e.target).offset();
	console.log(position);
	var left = position.left-27;
	var top = position.top+28 ;

	$("#right .areaCard").css({
		"left":left,
		"top":top
	}).removeClass("hide");
	e.stopPropagation();
}
/*页面3 - 隐藏更多信息*/
function hideAreaCard(evt){
	if($(evt.target).parents(".areaCard").length==0){
		$('.areaCard').addClass('hide');
	}
}

/* 页面3 - 算法管理 */
function showAverageRainfall(){
	$("#averageRainfall").modal("show");
	$(".modify").click(function(){
		$("#averageRainfallModify").modal("show");
		//仅保留一个背景颜色
		$(".modal-backdrop").css("opacity",0);
		$(".modal-backdrop")[0].style.opacity = 0.3;
	});
}
/* 页面3 - 算法管理: 修改 */
function showAverageRainfallModify(){
	$("#averageRainfallModify").modal("show");
	//仅保留一个背景颜色
	$(".modal-backdrop").css("opacity",0);
	$(".modal-backdrop")[0].style.opacity = 0.3;
}
/*第4页 - 查询显示区域列表*/
function getAreaList(){
	$.ajax({
		url:getListOfAreaUrl,
		type:'get',
		success: function(result){
			if (result.status === 0) {
				$(".rightContent4 .right-table-body-dataBind").render(result.data);
				setLeftHeight();
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

/* 页面4 - 修改区域 */
function modifyArea(e){

	var id = $(e.target).parents(".right-table-row").find("[data-bind=area_id]").val();
	$.ajax({
		url:getAreaDetailInfoUrl,
		type:'get',
		data:{
			areaId: id
		},
		dataType: 'json',
		success: function(result){
			if (result.status === 0) {
				$("#createField form")[0].reset();  //清空form
				$("#createField .modal-header>span").text("修改-测报数据");  //更换表头名称
				$("#createField .modal-body-item:eq(0) input").val(result.data.area_name);  //form填入数据
				$("#createField").modal("show");  //显示出弹窗
			}else{
				/*显示错误信息弹窗*/
			}
		},
		error: function(XMLHttpRequest){
			// error_500(XMLHttpRequest.responseText);
		}
	});
}

/*设置页面高度*/
function setLeftHeight(){
	// 1. 先清除高度
	$("#left").height("");
	$("#right").height("");
	// 2. 获取高度,用于比较
	var heightLeft= $("#left").outerHeight(true);
	var heightRight= $("#right").outerHeight(true);
	// 3. 比较并赋值
	if (heightLeft > heightRight) {
		// 动态获取margin和padding值
		var rightMt = parseInt($("#right").css("marginTop"));
		var rightMb = parseInt($("#right").css("marginBottom"));
		var rightPt = parseInt($("#right").css("paddingTop"));
		var rightBt = parseInt($("#right").css("paddingBottom"));
		$("#right").height(heightLeft-rightMt-rightMb-rightPt-rightBt);
	}else{
		$("#left").height(heightRight);
	}
}

$(function(){
	setLeftHeight();

	$('.left-item').click(changeLeftNav);
	/**自动测报数据修补tabs切换**/
	$('.rightContent1 .btn-tabs button').click(function(){
		$(this).addClass('active').siblings().removeClass('active');
	});
	/**增补**/
	$('#augment').click(function(){
 		$("#augmentModal").modal("show");
	})
	/**测站信息管理**/

	/* 页面3 and 页面4 - 显示更多信息 */
	$(".rightContent3 .right-table-body,.rightContent4 .right-table-body").on("click","i.introself",showAreaCard);
	/* 页面3 - 隐藏更多信息 */
	$(document).click(hideAreaCard);

	/* 页面3 - 算法管理 */
	$(".rightContent3 .create").click(showAverageRainfall);
	/* 页面3 - 算法管理: 修改 */
	$("#averageRainfall li.modify").click(showAverageRainfallModify);
	/* 页面3 - 算法管理 - 修改: 切换测站 */
	$("#averageRainfallModify .rainfall-item3 .rainfall-right>div").click(function(){
		$(this).toggleClass("active");
	});


	/**区域信息管理**/
	/* 页面4 - 新建区域 */
	$(".rightContent4 .create").click(function(){
		$("#createField").modal("show");
	});
	/* 页面4 - 修改区域 */
	$(".rightContent4 .right-table-body").on("click",".modify",modifyArea);



});
