<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mybatisPro.myBatisDao.StationMapper">
	<cache type="mybatisPro.mybatisRedis.MybatisRedisCache" />
	
	<!-- 创建站点信息 -->
	<insert id="createStation" parameterType="mybatisPro.mybatisEntity.StationEntity"
	keyProperty="id" useGeneratedKeys="true">
		INSERT INTO `ST_BS_STBPRP_B` (
			`sys_code`, `stcd`, `station_name`,`x`,`y`,`longitude`, `latitude`, `station_location`,`station_type`,
			`station_type_id`, `area_id`,`time_off`,`contract`,`telephone`,`comments`, `modify_time`) 
		VALUES(
			#{sys_code}, #{stcd}, #{station_name},#{x},#{y},#{longitude}, #{latitude}, #{station_location}, 
		    #{station_type},#{station_type_id}, #{area_id},#{time_off},#{contract},#{telephone},#{comments}, #{modify_time}
		);
	</insert>
	
	<!-- 查询测站列表信息 -->
	<select id="getStationList" resultType="map">
		SELECT
		    ST_BS_STBPRP_B.*,
		    AREA.area_name, 
		    ST_BS_STTYPE_B.type_name
		FROM
		    rwdb.ST_BS_STBPRP_B
		    INNER JOIN rwdb.ST_BS_STTYPE_B 
		        ON (ST_BS_STBPRP_B.station_type_id = ST_BS_STTYPE_B.sta_type_id)
		    INNER JOIN rwdb.AREA 
		        ON (ST_BS_STBPRP_B.area_id = AREA.area_id)
		    WHERE ST_BS_STBPRP_B.station_type = #{stationType};
	</select>
	
	<!-- 查询所有雨量测站列表信息 -->
	<select id="getRainfallStationList" resultType="map" useCache="false">
		SELECT
			ST_BS_STBPRP_B.*,
			ST_RP_PPTN_R.id AS rainfall_id,
			SUM(ST_RP_PPTN_R.time_rainfall) AS rainfall
		FROM
			rwdb.ST_BS_STBPRP_B
		INNER JOIN rwdb.ST_BS_STTYPE_B ON (
			ST_BS_STBPRP_B.station_type_id = ST_BS_STTYPE_B.sta_type_id
		)
		LEFT JOIN rwdb.ST_RP_PPTN_R ON (
			ST_RP_PPTN_R.sta_id=ST_BS_STBPRP_B.id 
		)
		WHERE
			ST_BS_STBPRP_B.id = #{staId}
		AND 
			ST_RP_PPTN_R.time 
			BETWEEN #{beginTime} AND #{endTime}
		 GROUP BY ST_BS_STBPRP_B.id;
	</select>
	
	<!-- 查询测站详情信息 -->
	<select id="getStationInfoById" resultType="map">
		SELECT
			ST_BS_STBPRP_B.*,
			ST_BS_STTYPE_B.type_name
		FROM
			rwdb.ST_BS_STBPRP_B
		INNER JOIN rwdb.ST_BS_STTYPE_B ON (
			ST_BS_STBPRP_B.station_type_id = ST_BS_STTYPE_B.sta_type_id
		)
		WHERE ST_BS_STBPRP_B.id = #{id};
	</select>
	
	<!-- 根据测站名称查询测站信息 -->
	<select id="findStationInfoByStaName" resultType="mybatisPro.mybatisEntity.StationEntity">
		select * from ST_BS_STBPRP_B where station_name = #{staName};
	</select>
	
	<!-- 更新测站信息 -->
	<update id="updateStationInfo" parameterType="mybatisPro.mybatisEntity.StationEntity">
		UPDATE ST_BS_STBPRP_B
		<set>
			<if test="sys_code!=null">
				sys_code=#{sys_code},
			</if>
			<if test="stcd!=null">
				stcd=#{stcd},
			</if>
			<if test="station_name!=null">
				station_name=#{station_name},
			</if>
			<if test="x!=null">
				x=#{x},
			</if>
			<if test="y!=null">
				y=#{y},
			</if>
			<if test="longitude!=null">
				longitude=#{longitude},
			</if>
			<if test="latitude!=null">
				latitude=#{latitude},
			</if>
			<if test="station_location!=null">
				station_location=#{station_location},
			</if>
			<if test="station_type!=null">
				station_type=#{station_type},
			</if>
			<if test="station_type_id!=null">
				station_type_id=#{station_type_id},
			</if>
			<if test="time_off!=null">
				time_off=#{time_off},
			</if>
			<if test="contract!=null">
				contract=#{contract},
			</if>
			<if test="telephone!=null">
				telephone=#{telephone},
			</if>
			<if test="area_id!=null">
				area_id=#{area_id},
			</if>
			<if test="comments!=null">
				comments=#{comments},
			</if>
			<if test="modify_time!=null">
				modify_time=#{modify_time}
			</if>
 			where id=#{id}
		</set>
	</update>
	
	<select id="getStationIdByTypeId" resultType="Long">
		SELECT ST_BS_STBPRP_B.id FROM ST_BS_STBPRP_B WHERE ST_BS_STBPRP_B.station_type_id = #{typeId};
	</select>
	
	<select id="getTypeOfStationIds" resultType="Long">
		SELECT 
			ST_BS_STBPRP_B.id 
		FROM ST_BS_STBPRP_B 
		WHERE ST_BS_STBPRP_B.station_type = #{staType};
	</select>
	
	<select id="getStationInfoByTypeId" resultType="map">
		SELECT
			ST_BS_STBPRP_B.id,
			ST_BS_STBPRP_B.sys_code,
			ST_BS_STBPRP_B.station_location,
			ST_BS_STBPRP_B.station_name,
			ST_BS_STBPRP_B.x,
			ST_BS_STBPRP_B.y
		FROM
			ST_BS_STBPRP_B
		WHERE
			ST_BS_STBPRP_B.station_type_id = #{typeId};
	</select>
	
	<!-- 插入参数编码数据 -->
	<insert id="insertParamCode" parameterType="mybatisPro.mybatisEntity.ParamCodeEntity"
	keyProperty="sta_id" useGeneratedKeys="true">
	
		INSERT INTO `ST_BS_STBPRP_B` (
			`sta_id`, `param_id`, `corvalue`) 
		VALUES(
			#{sta_id}, #{param_id}, #{corvalue}
		);
	</insert>
	
	<!-- 批量参数编码列表 -->
	<insert id="insertParamCodeData" parameterType="list">
		insert into rwdb.ParamId_StationId(
			sta_id,param_id,corvalue
		)values
		<foreach collection="codeEntities" index="index" item="item" separator=",">
			(#{item.sta_id},#{item.param_id},#{item.corvalue})
		</foreach>
		
	</insert>
	
	<!-- 根据测站唯一编码查询测站信息 -->
	<select id="findStationInfoBySysCode" resultType="mybatisPro.mybatisEntity.StationEntity">
		select * from ST_BS_STBPRP_B where sys_code = #{sysCode};
	</select>
	
	<!-- 根据测站ID查询参数编码数据 -->
	<select id="getParamCodeListByStaId" resultType="mybatisPro.mybatisEntity.ParamCodeEntity">
		select * from ParamId_StationId where sta_id = #{staId};
	</select>
	
	<!-- 删除测站 -->
	<delete id="deleteStation" parameterType="Long">
		DELETE FROM ST_BS_STBPRP_B WHERE id = #{staId};
	</delete>
	
	<!-- 删除雨量数据（实时表） -->
	<delete id="deleteStaRainfallData" parameterType="Long">
		DELETE FROM ST_RP_PPTN_R WHERE sta_id = #{staId};
	</delete>
	
	<!-- 删除雨量数据（小时数据表） -->
	<delete id="deleteStaRainfallDataH" parameterType="Long">
		DELETE FROM ST_RP_PPTN1H_R WHERE sta_id = #{staId};
	</delete>
	
	<!-- 删除雨量数据（天数据表） -->
	<delete id="deleteStaRainfallDataD" parameterType="Long">
		DELETE FROM ST_RP_PPTN1D_R WHERE sta_id = #{staId};
	</delete>
	
	<!-- 删除雨量数据（月数据表） -->
	<delete id="deleteStaRainfallDataM" parameterType="Long">
		DELETE FROM ST_RP_PPTN1M_R WHERE sta_id = #{staId};
	</delete>
	
	<!-- 删除水库水位数据 -->
	<delete id="deleteStaResWaterlevelData" parameterType="Long">
		DELETE FROM ST_WZ_RSVR_R WHERE sta_id = #{staId};
	</delete>
	
	<!-- 删除河道水位数据 -->
	<delete id="deleteStaRiverWaterlevelData" parameterType="Long">
		DELETE FROM ST_WZ_RIVER_R WHERE sta_id = #{staId};
	</delete>
	
	<!-- 删除系数编码列表中该站数据 -->
	<delete id="deleteStaParamCodeData" parameterType="Long">
		DELETE FROM ParamId_StationId WHERE sta_id = #{staId};
	</delete>
	
	<!-- 删除测站状态列表中该站数据 -->
	<delete id="deleteStaStatusData" parameterType="Long">
		DELETE FROM station_status WHERE sta_id = #{staId};
	</delete>
	
	<!-- 删除系数列表中该区域所有测站系数数据 -->
	<delete id="deleteStaAvgParamData" parameterType="Long">
		DELETE FROM paramTable WHERE area_id = #{areaId};
	</delete>
	
	
	<!-- 查询该站在雨量实时表有没有数据 -->
	<select id="countRainfall" parameterType="Long" resultType="int">
		SELECT COUNT(*) FROM ST_RP_PPTN_R WHERE sta_id = #{staId};
	</select>
	
	<!-- 查询该站在雨量小时表有没有数据 -->
	<select id="countRainfallH" parameterType="Long" resultType="int">
		SELECT COUNT(*) FROM ST_RP_PPTN1H_R WHERE sta_id = #{staId};
	</select>
	
	<!-- 查询该站在雨量天表有没有数据 -->
	<select id="countRainfallD" parameterType="Long" resultType="int">
		SELECT COUNT(*) FROM ST_RP_PPTN1D_R WHERE sta_id = #{staId};
	</select>
	
	<!-- 查询该站在雨量月表有没有数据 -->
	<select id="countRainfallM" parameterType="Long" resultType="int">
		SELECT COUNT(*) FROM ST_RP_PPTN1M_R WHERE sta_id = #{staId};
	</select>
	
	<!-- 查询该站在水库水位表有没有数据 -->
	<select id="countResWaterLevel" parameterType="Long" resultType="int">
		SELECT COUNT(*) FROM ST_WZ_RSVR_R WHERE sta_id = #{staId};
	</select>
	
	<!-- 查询该站在河道水位表有没有数据 -->
	<select id="countRiverWaterLevel" parameterType="Long" resultType="int">
		SELECT COUNT(*) FROM ST_WZ_RIVER_R WHERE sta_id = #{staId};
	</select>
	
	<!-- 查询该站在系数编码列表中有没有数据 -->
	<select id="countParamCode" parameterType="Long" resultType="int">
		SELECT COUNT(*) FROM ParamId_StationId WHERE sta_id = #{staId};
	</select>
	
	<!-- 查询该站在测站状态列表中有没有数据 -->
	<select id="countStaStatus" parameterType="Long" resultType="int">
		SELECT COUNT(*) FROM station_status WHERE sta_id = #{staId};
	</select>
	
	<!-- 查询该区域下测站有没有系数数据 -->
	<select id="countStaAvgParamData" parameterType="Long" resultType="int">
		SELECT COUNT(*) FROM paramTable WHERE area_id = #{areaId};
	</select>
</mapper>