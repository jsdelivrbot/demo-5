var thisDate = new Date();
var todayNumber = thisDate.getDate();
var tomonthNumber = thisDate.getMonth()+1;
var toyearNumber = thisDate.getFullYear();

//切换月份
function clickLeftOrRightMonth(){
	if ($(this)[0].className.indexOf("prevButton")!==-1) {
		datePrev();
	}else {
		dateNext();
	}
	refreshMonthData();
	// initTable();
	setLeftAndRightMonthStatus();
}

//设置月份左右按钮状态
function setLeftAndRightMonthStatus(){
	var arr = $('#monthsPicker').val().split("-");

	$(".nextButton").removeClass("active");
	if (Number(arr[0]) < Number(toyearNumber)) {
		$(".nextButton").addClass("active");
	}else if (Number(arr[0]) === Number(toyearNumber)) {
		if (Number(arr[1]) < Number(tomonthNumber)) {
			$(".nextButton").addClass("active");
		}
	}
}

// 查询测站状态
function initTable(){
	var createStatusHTML = function(a,b,c){
		var result;
		if (c.type === 12) {
			result = "<i class='circle normal'></i>";
		}else if(c.type === 13){
			result = "<i class='circle abnormal'></i>";
		}else if(c.type === 14){
			result = "<i class='circle bad'></i>";
		}
		return result;
	};

	var arrName = ["测站名称","1日","2日","3日","4日","5日","6日","7日","8日","9日","10日","11日","12日","13日","14日","15日","16日","17日","18日","19日","20日","21日","22日","23日","24日","25日","26日","27日","28日","29日","30日","31日"];
    var arrModel = [
        {name: 'station_name',align:'center',width:312,sortable:false},
        {name: '1',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '2',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '3',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '4',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '5',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '6',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '7',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '8',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '9',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '10',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '11',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '12',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '13',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '14',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '15',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '16',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '17',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '18',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '19',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '20',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '21',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '22',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '23',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '24',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '25',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '26',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '27',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '28',align:'center',sortable:false,formatter: createStatusHTML},
        {name: '29',align:'center',sortable:false,formatter: createStatusHTML,hidden:false},
        {name: '30',align:'center',sortable:false,formatter: createStatusHTML,hidden:false},
        {name: '31',align:'center',sortable:false,formatter: createStatusHTML,hidden:false}
    ];

	var yyyymmArr = $("#monthsPicker").val().split("-");
	var startTime = $("#monthsPicker").val()+"-01";
	var endTime = $("#monthsPicker").val()+"-"+getLastDay(yyyymmArr[0],yyyymmArr[1]);

	$("#rainfallTable").jqGrid({
        url: getStatusInfoListUrl,
        mtype: 'get',
        datatype: 'json',
        postData: {
			begin_time: startTime,
			end_time: endTime
        },
        jsonReader : {
            root: "data",
            repeatitems: false
        },
        colNames: arrName,
        colModel: arrModel,
        autowidth: true,  //自适应宽度
        shrinkToFit: true,
        height: 'auto',
        viewrecords: true,
        loadonce: true,  //设置为true 可以导出文件
        altRows:false,
        loadui: 'disable',
		loadComplete: function(){
			// 获取此月天数
			var yyyymmArr = $("#monthsPicker").val().split("-");
		    var lastDate = getLastDay(yyyymmArr[0],yyyymmArr[1]);

		    if (lastDate === 30) {
		        $("#rainfallTable").showCol("29").showCol("30").hideCol("31").trigger("reloadGrid");
		    }else if(lastDate === 29){
		        $("#rainfallTable").showCol("29").hideCol("30").hideCol("31").trigger("reloadGrid");
		    }else if(lastDate === 28){
		        $("#rainfallTable").hideCol("29").hideCol("30").hideCol("31").trigger("reloadGrid");
		    }else{
		        $("#rainfallTable").showCol("29").showCol("30").showCol("31").trigger("reloadGrid");
		    }
		}
    });
}
// 更新数据
function refreshMonthData(){
	var yyyymmArr = $("#monthsPicker").val().split("-");

    $("#rainfallTable").setGridParam({postData: {
		begin_time: $("#monthsPicker").val()+"-01",
		end_time: $("#monthsPicker").val()+"-"+getLastDay(yyyymmArr[0],yyyymmArr[1])
    },datatype:'json', page:1}).trigger('reloadGrid');
}


$(function(){
	$('#monthsPicker').val(DateToday('months'));
	initTable();
	//切换月份
   $(".pickerBox").on("click",".prevButton.active,.nextButton.active",clickLeftOrRightMonth);
});
