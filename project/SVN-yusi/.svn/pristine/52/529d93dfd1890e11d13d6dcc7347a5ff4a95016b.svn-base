/**
 * Created by EKuter-amu on 2017/7/10.
 */

window.onresize = function() {
  setMapHeight();
}
function setMapHeight() {
  $('.mapBox').css('max-height',$('.contentRight').outerHeight(true)+5+'px');
}

function rainPointInfos(getRainfallStationCountInfo){

  $.each(getRainfallStationCountInfo, function(i, ele) {
    Map.rainAddPoints([ele.x,ele.y], ele.station_name,ele.rainfall);
    Map.rainSetInfos([ele.x,ele.y],ele.station_name,ele.rainfall, ele.id);
  });
}
function waterPointInfos(getRainfallStationCountInfo){

  $.each(getRainfallStationCountInfo, function(i, ele) {

    Map.waterAddPoints([ele.x,ele.y], ele.station_name,ele.waterLineType);
    Map.waterSetInfos([ele.x,ele.y],ele.station_name,ele.waterLine,ele.id);
  });
}

function tabsChange(){
    $(this).addClass('active').siblings().removeClass('active');
    $('.tab-pannel').eq($(this).index()).addClass('active').siblings().removeClass('active');

    if($(this).hasClass('tabs1')){//实时水情
      //清除点和信息 设置水情点和信息
      removeNameAndPoint();
      setMapHeight();
      getReservoirInfo();//获取水库信息
      getRiverwayInfo();//获取河道信息
    }else if($(this).hasClass('tabs2')){//实时雨情
        removeNameAndPoint();
      getRainfallStationCountInfo();//雨量信息
      getRainfallStatisticsList();//雨量统计
    }
}
// function rainInfoDetail(){

//   $('#rainInfoDetailModal').modal('show');
// }



//水库信息
function getReservoirInfo(){
  //模拟数据
var reservoirInfoList=[

{id:"201",sys_code: "#001", station_name: "水库站1",waterLine:"10.00", waterLineType:"0",storage:"500",x:-11241529,y:4692214},
{id:"202",sys_code: "#002", station_name: "水库站2",waterLine:"11.00", waterLineType:"0",storage:"500",x:-7601903.5,y:5846719},
{id:"203",sys_code: "#003", station_name: "水库站3",waterLine:"12.00", waterLineType:"0",storage:"500",x:-9284741,y:5494497},
{id:"204",sys_code: "#004", station_name: "水库站4",waterLine:"13.00", waterLineType:"0",storage:"500",x:-13765786,y:4868325},
{id:"205",sys_code: "#005", station_name: "水库站5",waterLine:"14.00", waterLineType:"0",storage:"500",x:-12767824,y:6277212},
{id:"206",sys_code: "#006", station_name: "水库站6",waterLine:"15.00", waterLineType:"0",storage:"500",x:-8560730,y:5357522},
{id:"207",sys_code: "#007", station_name: "水库站7",waterLine:"16.00", waterLineType:"0",storage:"500",x:-8502026,y:4339992},
{id:"208",sys_code: "#008", station_name: "水库站8",waterLine:"17.00", waterLineType:"0",storage:"500",x:-8991223,y:3811659.2},
{id:"209",sys_code: "#009", station_name: "水库站9",waterLine:"18.00", waterLineType:"0",storage:"500",x:-13354860,y:4026906},
{id:"210",sys_code: "#010", station_name: "水库站10",waterLine:"19.00", waterLineType:"0",storage:"500",x:-11926405,y:3635548.5},
{id:"211",sys_code: "#011", station_name: "水库站11",waterLine:"20.00", waterLineType:"0",storage:"500",x:-11926405,y:3835548}
];
  $('.panelRow2 .panelRow2-dataBind').render(reservoirInfoList);
  waterPointInfos(reservoirInfoList);


}
//河道信息
function getRiverwayInfo(){
    //模拟数据
var arr=[

{id:"301",sys_code: "#101", station_name: "河道站1",waterLine:"10.00", waterLineType:"1",storage:"500",x:-11757242,y:4763147},
{id:"302",sys_code: "#102", station_name: "河道站2",waterLine:"11.00", waterLineType:"1",storage:"500",x:-10915824,y:3099877},
{id:"303",sys_code: "#103", station_name: "河道站3",waterLine:"12.00", waterLineType:"1",storage:"500",x:-10857120,y:4958826},
{id:"304",sys_code: "#104", station_name: "河道站4",waterLine:"13.00", waterLineType:"1",storage:"500",x:-9487368,y:3902160},
{id:"305",sys_code: "#105", station_name: "河道站5",waterLine:"14.00", waterLineType:"1",storage:"500",x:-12676933,y:5213208},
{id:"306",sys_code: "#106", station_name: "河道站6",waterLine:"15.00", waterLineType:"1",storage:"500",x:-10426627,y:5995923}
];
  $('.panelRow3 .panelRow3-dataBind').render(arr);
  waterPointInfos(arr);

}


/**雨量信息**/
function getRainfallStationCountInfo(){
  var beginTime=$('#starttime1').val();
  var endTime=$('#endtime1').val();

    $.ajax({
    url: rainfallStationCountInfoUrl,
    type: 'get',
    data: {
      begin_time: beginTime,
      end_time: endTime
    },
    dataType: 'json',
    success: function(result){
        if(result.status==0){
           var getRainfallStationCountInfo=result.data;

           if(getRainfallStationCountInfo&&getRainfallStationCountInfo.length==0){
                $('.tab-pannel2 .panelRow2 .panelRow2-dataBind').render('');
                $('#errorBtn').modal('show');
                $('#errorInfo').html('雨量信息无内容');
           }else{
              //console.log(getRainfallStationCountInfo);
              $('.tab-pannel2 .panelRow2 .panelRow2-dataBind').render(getRainfallStationCountInfo);
              rainPointInfos(getRainfallStationCountInfo);
              setMapHeight();
           }
        }else{
            $('#errorBtn').modal('show');
            $('#errorInfo').html('数据加载异常');
        }


    },
    error: function(err){
      console.log(err);
    }
  });
}

/**雨量统计**/
function getRainfallStatisticsList(){

  var beginTime=$('#starttime1').val();
  var endTime=$('#endtime1').val();
  $.ajax({
    url: areaAverageRainfallUrl,
    type: 'get',
    data: {
      begin_time: beginTime,
      end_time: endTime
    },
    dataType: 'json',
    success: function(result){

       var rainfallStatisticsList=result.data;
       if(rainfallStatisticsList&&rainfallStatisticsList.length==0){
                $('#errorBtn').modal('show');
                $('#errorInfo').html('雨量统计无内容');
       }else{

        var arr=[];
        var str='';
        $.each(rainfallStatisticsList,function(idx,obj){
          if(obj.area_name=="全库"){
            rainfallStatisticsList.splice(idx,1); //把全库的项清除
          }
          if (null==obj.average_rainfall||null==obj.maxStation||null==obj.max_Rainfall) {
            obj.average_rainfall=obj.maxStation=obj.max_Rainfall = "——";
          }
          arr.push(obj.station_info_list);
        });


        // console.log(arr);class 绑定不上去
        var aa={
          rainfall:{
              class: function() {

                return arr.rainfall;
              }
          }
        };

        $('.panelRow3 .right-table-body-dataBind').render(rainfallStatisticsList);
        $('#popInfoTr').render(rainfallStatisticsList,aa);
        setMapHeight();
       }

    },
    error: function(err){
      console.log(err);
    }
  });
}

/*清除 站名 and 站点*/
function removeNameAndPoint(){
    var length =map.getLayers().a.length;
    while(length>1){
        map.removeLayer(map.getLayers().item(1));
        length = map.getLayers().a.length;
    }

    $(".popup").remove();
}

//获取当前日期
function DateToday(flag) {
  var d = new Date();
  var year = d.getFullYear();
  var month = d.getMonth() + 1;
  if (month < 10) {
    month = '0' + month;

  }
  var day = d.getDate();
  if (day < 10) {
    day = '0' + day;
  }
  var hour = d.getHours();
  if (hour < 10) {
    hour = '0' + hour;
  }  
  var min = d.getMinutes();
 if (min < 10) {
    min = '0' + min;
  }
  var str = year + "-" + month + "-" + day + " " + hour + ":" + min;
  return str;

}
//获取上月今日
function prevMonthDateToday() {
  var d = new Date();
  var year = d.getFullYear();
  var month = d.getMonth();
  if (month < 10) {
    month = '0' + month;

  }
  var day = d.getDate();
  if (day < 10) {
    day = '0' + day;
  }
  var str = year + "-" + month + "-" + day + " " + "00:00";
  return str;
}
/*点击[详情],显示弹窗*/
function showDetail() {
  var popInfoStartTime=$('#starttime1').val();
  var popInfoEndTime=$('#endtime1').val();
  $('#popInfo').modal('show');

  $('#popInfoStartTime').html(popInfoStartTime);//开始时间
  $('#popInfoEndTime').html(popInfoEndTime);//结束时间

}

$(function() {
  Map.init(false);
  setMapHeight();
  $('.tabs').click(tabsChange);

  getReservoirInfo();//获取水库信息
  getRiverwayInfo();//获取河道信息
 $('.panelRow2-dataBind,.panelRow3-dataBind').off('click').on('click','ul',function(){
        var x=parseInt($(this).find('li:first input[data-bind="x"]').val());
        var y=parseInt($(this).find('li:first input[data-bind="y"]').val());
        var view = map.getView();
        var zoom = view.getZoom();
        view.setCenter([x,y]);//设置中心
        view.setZoom(zoom + 3);//放大
        $('.popup').css('color','white');
        $('#popup'+$(this).find('input[data-bind="id"]').val()).css('color','red');//高亮layer
  });

  $('#starttime,#starttime1').val(prevMonthDateToday);
  $('#endtime,#endtime1').val(DateToday);

  //点击保存切换列表数据
  $('#rain_search_btn').click(function(){
    //清除point,info
    removeNameAndPoint();
    getRainfallStationCountInfo();
    getRainfallStatisticsList();

  });

  /*单击详情,显示弹窗*/
  $(".pannel-title .detail").click(showDetail);

  /**切换图例**/
  $('.contentRightTabs .tabs1').click(function() {
    $('#waterLengend').removeClass('hide').siblings('.lengendBox').addClass('hide');
  });
  $('.contentRightTabs .tabs2').click(function() {
    $('#rainLengend').removeClass('hide').siblings('.lengendBox').addClass('hide');
  });

  /**切换图例按钮**/
  $('.legendTitle').click(function() {
    if ($('.legend-content').hasClass('in')) { //展开
      $('.triangular').removeClass('rotate');
    } else {
      $('.triangular').addClass('rotate');
    }
  });
})

// document.getElementById('zoom-out').onclick = function() {
//     var view = map.getView();
//     var zoom = view.getZoom();
//     view.setZoom(zoom - 1);
// };

// document.getElementById('zoom-in').onclick = function() {
//     var view = map.getView();
//     var zoom = view.getZoom();
//     view.setZoom(zoom + 1);
// };
