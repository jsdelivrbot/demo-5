<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mybatisPro.myBatisDao.RainfallStatisticsMapper">
	<cache type="mybatisPro.mybatisRedis.MybatisRedisCache" />
	
	<!-- 小时 -->
	<insert id="statisticsByHour" statementType="CALLABLE" >
		{CALL rwdb.STATISTICAL_HOURS(#{now_time})}
	</insert>
	
	<!-- 天 -->
	<insert id="statisticsByDays" statementType="CALLABLE" >
		{CALL rwdb.STATISTICAL_DAYS(#{now_time})}
	</insert>
	
	<!-- 月 -->
	<insert id="statisticsByMonths" statementType="CALLABLE" >
		{CALL rwdb.STATISTICAL_MONTH(#{now_time})}
	</insert>
	
	<!-- 校验雨量信息 -->
	<select id="checkRainInfo" resultType="int" useCache="false">
		SELECT 
			COUNT(1) 
		FROM 
			<if test="type=='hour'.toString()">
				ST_RP_PPTN1H_R 
			</if>
			<if test="type=='day'.toString()">
				ST_RP_PPTN1D_R 
			</if>
			<if test="type=='months'.toString()">
				ST_RP_PPTN1M_R 
			</if>
		WHERE 
			<if test="type=='hour'.toString()">
				DATE_FORMAT(TIME,'%Y-%m-%d')=DATE_FORMAT(#{now_time},'%Y-%m-%d') AND HOUR(TIME)=HOUR(DATE_ADD(#{now_time},INTERVAL -1 HOUR))
			</if>
			<if test="type=='day'.toString()">
				DATE_FORMAT(TIME,'%Y-%m-%d')=DATE_FORMAT(#{now_time},'%Y-%m-%d')
			</if>
			<if test="type=='months'.toString()">
				DATE_FORMAT(`time`,'%Y-%m')=DATE_FORMAT(DATE_SUB(#{now_time},INTERVAL 1 MONTH),'%Y-%m')
			</if>	
	</select>
	
	<!-- 删除雨量数据 -->
	<delete id="deleteRainInfo">
		DELETE FROM
			<if test="type=='hour'.toString()">
				ST_RP_PPTN1H_R 
			</if>
			<if test="type=='day'.toString()">
				ST_RP_PPTN1D_R 
			</if>
			<if test="type=='months'.toString()">
				ST_RP_PPTN1M_R 
			</if>
		WHERE 
			<if test="type=='hour'.toString()">
				DATE_FORMAT(TIME,'%Y-%m-%d')=DATE_FORMAT(#{now_time},'%Y-%m-%d') AND HOUR(TIME)=HOUR(DATE_ADD(#{now_time},INTERVAL -1 HOUR))
			</if>
			<if test="type=='day'.toString()">
				DATE_FORMAT(TIME,'%Y-%m-%d')=DATE_FORMAT(#{now_time},'%Y-%m-%d')
			</if>
			<if test="type=='months'.toString()">
				DATE_FORMAT(`time`,'%Y-%m')=DATE_FORMAT(DATE_SUB(#{now_time},INTERVAL 1 MONTH),'%Y-%m')
			</if>	
	</delete>
	
	<!-- 年统计 -->
	<select id="statisticsByYear"  resultType="map" useCache="false">
		SELECT
		   `ST_BS_STBPRP_B`.`sys_code`
		   , `ST_BS_STBPRP_B`.`station_name`
		    ,SUM(CASE YEAR(TIME) WHEN #{year} THEN time_rainfall ELSE NULL END) AS total
		   ,SUM(CASE MONTH(TIME) WHEN 1 THEN time_rainfall ELSE NULL END) AS Jan
		   ,SUM(CASE MONTH(TIME) WHEN 2 THEN time_rainfall ELSE NULL END) AS Feb
		   ,SUM(CASE MONTH(TIME) WHEN 3 THEN time_rainfall ELSE NULL END) AS Mar
		   ,SUM(CASE MONTH(TIME) WHEN 4 THEN time_rainfall ELSE NULL END) AS Apr
		   ,SUM(CASE MONTH(TIME) WHEN 5 THEN time_rainfall ELSE NULL END) AS May
		   ,SUM(CASE MONTH(TIME) WHEN 6 THEN time_rainfall ELSE NULL END) AS Jun
		   ,SUM(CASE MONTH(TIME) WHEN 7 THEN time_rainfall ELSE NULL END) AS Jul
		   ,SUM(CASE MONTH(TIME) WHEN 8 THEN time_rainfall ELSE NULL END) AS Aug
		   ,SUM(CASE MONTH(TIME) WHEN 9 THEN time_rainfall ELSE NULL END) AS Sep
		   ,SUM(CASE MONTH(TIME) WHEN 10 THEN time_rainfall ELSE NULL END) AS Octb
		   ,SUM(CASE MONTH(TIME) WHEN 11 THEN time_rainfall ELSE NULL END) AS Nov
		   ,SUM(CASE MONTH(TIME) WHEN 12 THEN time_rainfall ELSE NULL END) AS Dece
	    FROM
	    	`rwdb`.`ST_RP_PPTN1M_R`
		    INNER JOIN `rwdb`.`ST_BS_STBPRP_B` 
		        ON (`ST_RP_PPTN1M_R`.`sta_id` = `ST_BS_STBPRP_B`.`id`)
		   <!--  INNER JOIN `rwdb`.`ST_BS_STTYPE_B` 
		        ON (`ST_BS_STBPRP_B`.`station_type_id` = `ST_BS_STTYPE_B`.`sta_type_id`) -->
	    WHERE
	   		YEAR(TIME)=#{year} AND ST_BS_STBPRP_B.`station_type`=#{type}
	    GROUP BY `ST_BS_STBPRP_B`.`station_name`
	</select>
	
	<!-- 天统计 -->
	<select id="statisticsByDay"  resultType="map" useCache="false">
		SELECT
		   `ST_BS_STBPRP_B`.`sys_code`
		   , `ST_BS_STBPRP_B`.`station_name`
		   ,SUM(time_rainfall) AS total
		   <foreach collection="hour_list" index="index" item="item" >
		   		,SUM(CASE HOUR(TIME) WHEN #{item} THEN time_rainfall ELSE NULL END) AS #{item}
		   </foreach>
	    FROM
		    	`rwdb`.`ST_RP_PPTN1H_R`
		    INNER JOIN `rwdb`.`ST_BS_STBPRP_B` 
		        ON (`ST_RP_PPTN1H_R`.`sta_id` = `ST_BS_STBPRP_B`.`id`)
		   <!--  INNER JOIN `rwdb`.`ST_BS_STTYPE_B` 
		        ON (`ST_BS_STBPRP_B`.`station_type_id` = `ST_BS_STTYPE_B`.`sta_type_id`) -->
	    WHERE
	   		TIME BETWEEN #{start_time}  AND #{end_time} AND ST_BS_STBPRP_B.`station_type`=6
	    GROUP BY `ST_BS_STBPRP_B`.`station_name`
	</select>
	
	<!-- 月统计 -->
	<select id="statisticsByMonth"  resultType="map" useCache="false">
		SELECT
		   `ST_BS_STBPRP_B`.`sys_code`
		   ,`ST_BS_STBPRP_B`.`station_name`
		   ,SUM(time_rainfall) AS total
		   <foreach collection="month_list" index="index" item="item" >
		   		,SUM(CASE DAY(TIME) WHEN #{item} THEN time_rainfall ELSE NULL END) AS #{item}
		   </foreach>
	   FROM
	   	 	`rwdb`.`ST_RP_PPTN1D_R`
		   INNER JOIN `rwdb`.`ST_BS_STBPRP_B` 
		       ON (`ST_RP_PPTN1D_R`.`sta_id` = `ST_BS_STBPRP_B`.`id`)
		   <!-- INNER JOIN `rwdb`.`ST_BS_STTYPE_B` 
		       ON (`ST_BS_STBPRP_B`.`station_type_id` = `ST_BS_STTYPE_B`.`sta_type_id`) -->
	   WHERE
	    	DATE_FORMAT(TIME,'%Y-%m')=#{months} AND ST_BS_STBPRP_B.station_type=#{type}
	   GROUP BY ST_BS_STBPRP_B.`station_name`
	</select>
	
	<select id="getHourInfo" resultType="long">
		SELECT id FROM `ST_RP_PPTN1H_R` WHERE DATE_FORMAT(TIME,'%Y-%m-%d')=DATE_FORMAT(#{time},'%Y-%m-%d') AND HOUR(TIME)=HOUR(#{time}) AND sta_id=#{sta_id}
	</select>
	
	<insert id="insertHourInfo">
		INSERT  INTO `ST_RP_PPTN1H_R`(sta_id,`time`,time_rainfall,createtime) VALUES(#{sta_id},DATE_FORMAT(#{time},'%Y-%m-%d %H'),#{time_rainfall},NOW())
	</insert>
	
	<update id="updateHourInfo">
		UPDATE ST_RP_PPTN1H_R
		<set>
			time_rainfall=time_rainfall+#{time_rainfall}
		</set>
		WHERE
			id=#{id}
	</update>
	
	<update id="updateHourInfos">
		UPDATE ST_RP_PPTN1H_R
		<set>
			time_rainfall=#{time_rainfall}
		</set>
		WHERE
			id=#{id}
	</update>
	
	
</mapper>